# 材价审计系统 - 部署交付包

## 📦 交付内容

本部署包为**纯净生产环境版本**，已剔除所有开发脏数据和历史部署文件。

### 包含内容
- ✅ 完整源代码（Vue 3 + Nuxt 3）
- ✅ 生产环境配置文件
- ✅ Docker部署支持
- ✅ PM2进程管理配置
- ✅ 数据库初始化脚本
- ✅ 完整部署文档

### 包大小
- **压缩前**: 约 740KB
- **安装依赖后**: 约 150-200MB

---

## 🚀 快速部署（3步启动）

### 第1步：验证环境
```bash
# 进入部署目录
cd deployment

# 运行验证脚本
./verify.sh
```

### 第2步：安装配置
```bash
# 安装依赖
npm install

# 配置环境变量
cp .env.example .env
# 编辑 .env 文件，填入Dify API配置
```

### 第3步：启动服务
```bash
# 方式1: 开发模式（测试用）
npm run dev

# 方式2: 生产模式（推荐）
npm run build
pm2 start ecosystem.config.js
```

---

## 📋 详细部署步骤

### 环境要求
| 软件 | 版本要求 | 说明 |
|------|---------|------|
| Node.js | >= 20.19.0 | JavaScript运行环境 |
| npm | >= 9.0.0 | 包管理工具 |
| MySQL | >= 8.0 | 数据库（可选） |
| PM2 | 最新版 | 进程管理（生产环境推荐） |

### 必填环境变量

编辑 `.env` 文件，填入以下配置：

```env
# Dify AI配置（必填）
DIFY_API_KEY=app-xxxxxxxxxxxxxxxxxxxxxxxx
DIFY_API_URL=https://api.dify.ai/v1/workflows/run

# 数据库配置（可选，不影响核心功能）
DB_HOST=localhost
DB_PORT=3306
DB_USER=your_user
DB_PASSWORD=your_password
DB_NAME=material_audit
```

### 数据库初始化（可选）

如需使用数据库功能：

```bash
# 1. 创建数据库
mysql -u root -p < database/schema.sql

# 2. 初始化表结构
mysql -u root -p material_audit < database/sql/init-tables.sql
```

### 构建部署

```bash
# 1. 构建生产版本
npm run build

# 2. 启动服务（选择一种方式）

# 方式A: 使用PM2（推荐）
npm install -g pm2
pm2 start ecosystem.config.js
pm2 save
pm2 startup

# 方式B: 使用npm
npm run preview

# 方式C: 使用Docker
docker-compose up -d
```

---

## 🐳 Docker部署（推荐）

### 使用Docker Compose（最简单）
```bash
# 1. 编辑 .env 文件配置环境变量
cp .env.example .env
vim .env

# 2. 启动容器
docker-compose up -d

# 3. 查看日志
docker-compose logs -f

# 4. 停止服务
docker-compose down
```

### 使用Dockerfile
```bash
# 1. 构建镜像
docker build -t material-audit:1.0.0 .

# 2. 运行容器
docker run -d \
  --name material-audit \
  -p 3000:3000 \
  -e DIFY_API_KEY=your_key \
  -e DIFY_API_URL=your_url \
  material-audit:1.0.0

# 3. 查看日志
docker logs -f material-audit
```

---

## 🔧 服务管理

### PM2命令
```bash
# 查看状态
pm2 status

# 查看日志
pm2 logs material-audit

# 重启服务
pm2 restart material-audit

# 停止服务
pm2 stop material-audit

# 删除服务
pm2 delete material-audit
```

### Docker命令
```bash
# 查看容器状态
docker ps

# 查看日志
docker logs -f material-audit

# 重启容器
docker restart material-audit

# 停止容器
docker stop material-audit
```

---

## 🌐 访问地址

部署成功后，访问：
- **本地**: http://localhost:3000
- **服务器**: http://your-server-ip:3000

### 验证部署
1. 打开浏览器访问上述地址
2. 点击"上传文件"按钮测试功能
3. 下载模板文件测试静态资源

---

## ⚠️ 重要提醒

### 必须配置
- ✅ `.env` 文件中的 `DIFY_API_KEY`
- ✅ `.env` 文件中的 `DIFY_API_URL`

### 可选配置
- 数据库配置（不配置不影响核心审计功能）
- 端口配置（默认3000）

### 安全建议
- ❌ 不要将 `.env` 文件提交到代码仓库
- ❌ 不要在公网暴露数据库端口
- ✅ 建议配置反向代理（Nginx）
- ✅ 建议启用HTTPS

---

## 📊 性能建议

### 服务器配置
- **最小配置**: 1核CPU + 1GB内存
- **推荐配置**: 2核CPU + 2GB内存
- **磁盘空间**: 最少1GB可用空间

### 并发处理
- 默认配置可处理100+并发请求
- 如需更高并发，可配置PM2集群模式

---

## 🆘 故障排查

### 1. 依赖安装失败
```bash
# 清理缓存重试
npm cache clean --force
rm -rf node_modules package-lock.json
npm install
```

### 2. 端口被占用
```bash
# 查看端口占用
lsof -i :3000

# 修改端口（编辑 nuxt.config.ts）
export PORT=3001
npm run dev
```

### 3. 内存不足
```bash
# 增加Node内存限制
export NODE_OPTIONS="--max-old-space-size=4096"
npm run build
```

### 4. 服务无法访问
- 检查防火墙规则
- 检查端口是否监听: `netstat -tuln | grep 3000`
- 检查服务日志: `pm2 logs` 或 `docker logs`

---

## 📞 技术支持

### 部署前准备
1. ✅ 阅读本文档
2. ✅ 运行 `./verify.sh` 验证环境
3. ✅ 准备好Dify API密钥

### 遇到问题时提供
- 错误日志（完整）
- 环境信息（Node版本、系统版本）
- 部署方式（PM2/Docker/npm）
- 已执行的操作步骤

---

## 📝 文件清单

```
deployment/
├── README.md                    # 部署说明（主文档）
├── 交付说明.md                  # 本文件
├── DEPLOYMENT_CHECKLIST.md     # 部署检查清单
├── verify.sh                   # 环境验证脚本
├── package.json                # 项目依赖
├── nuxt.config.ts              # Nuxt配置
├── .env.example                # 环境变量模板
├── Dockerfile                  # Docker镜像配置
├── docker-compose.yml          # Docker编排配置
├── ecosystem.config.js         # PM2配置
├── assets/                     # 静态资源
├── components/                 # Vue组件
├── composables/                # 组合式函数
├── database/                   # 数据库脚本
├── pages/                      # 页面路由
├── plugins/                    # 插件
├── public/                     # 公共资源
│   └── template.xls           # Excel模板
├── server/                     # 服务端API
└── types/                      # TypeScript类型
```

---

## ✅ 部署验证清单

部署完成后，请逐项检查：

- [ ] 服务正常启动（无错误日志）
- [ ] 能够访问首页
- [ ] 能够上传Excel文件
- [ ] 能够下载模板文件
- [ ] 能够发起审计（需配置Dify）
- [ ] 能够查看审计结果
- [ ] 能够导出审计报告

---

**版本**: v1.0.0  
**打包时间**: 2024-12-18  
**状态**: ✅ 已验证可部署

**祝部署顺利！** 🎉
