# 材价审计系统 - 内网部署指南 (Docker)

本指南针对内网服务器环境下，如何快速部署并启动材价审计系统。

## 1. 前置要求

在开始之前，请确保目标服务器已安装以下软件：
- **Docker**: >= 20.10.0
- **Docker Compose**: >= 2.0.0

## 2. 部署步骤

### 第一步：同步代码
将项目压缩包上传至服务器并解压：
```bash
unzip material_audit.zip -d /opt/material_audit
cd /opt/material_audit
```

### 第二步：配置环境变量
在服务器上创建并编辑 `.env` 文件：
```bash
cp .env.example .env
vi .env
```
**必须修改的参数：**
- `DIFY_API_KEY`: Dify 平台的 API 密钥
- `DIFY_API_URL`: Dify 的 API 地址（如内网 Dify，请确保容器内可访问该 IP）
- `DB_HOST`/`DB_PASSWORD`: 如果连接外部 MySQL，请按需修改。

### 第三步：运行部署脚本
执行脚本进行自动构建和启动：
```bash
# 赋予执行权限（如果尚未赋予）
chmod +x scripts/deploy-intranet.sh

# 运行脚本
./scripts/deploy-intranet.sh
```

## 3. 常用管理命令

### 查看日志
```bash
docker-compose logs -f app
```

### 停止服务
```bash
docker-compose down
```

### 重新构建（代码更新后）
```bash
docker-compose up -d --build
```

## 4. 常见问题 (FAQ)

1. **容器启动失败，提示无法连接 Redis？**
   - 检查 `docker-compose.yml` 中 redis 服务是否正常。如果是连接外部 Redis，请修改 `.env` 中的 `REDIS_HOST`。
2. **Dify API 调用超慢或超时？**
   - 确保内网服务器防火墙允许访问 Dify 服务器。
   - 检查 `.env` 中的 `DIFY_API_URL` 是否使用了正确的协议 (http/https) 和端口。
3. **如何迁移数据库结构？**
   - 部署完成后，手动执行 `database/sql/init-tables.sql` 到您的 MySQL 数据库中。
