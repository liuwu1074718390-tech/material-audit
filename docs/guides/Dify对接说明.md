# Dify对接完整说明

## 📋 已实现功能

### 1. 城市编码转换 ✅
- 从 `city_code/biz_district.sql` 提取城市编码映射
- 支持省级和市级编码转换
- 自动将用户选择的地区转换为Dify所需的编码格式

### 2. 时间范围格式化 ✅
- 输入格式：`['2024-01', '2024-12']`
- 输出格式：`'2024-01-01'|'2024-12-31'`
- 自动计算每月最后一天

### 3. 材料数据处理 ✅
- 自动为每个材料生成唯一ID（0001, 0002, ...）
- 支持按类别筛选材料
- 材料分组：每10条一组
- 并发控制：最多10组同时调用Dify

### 4. 后台任务管理 ✅
- 创建任务后立即返回，不阻塞前端
- 任务在后台持续运行，即使前端关闭也继续处理
- 支持任务状态查询和进度跟踪

### 5. 实时状态更新 ✅
- 前端每2秒轮询任务状态
- 实时显示处理进度
- 显示"查价中"和"查价完成"状态

### 6. 结果解析和计算 ✅
- 解析Dify返回的JSON数据
- 计算推荐价格范围
- 计算价格偏差百分比
- 支持含税/不含税价格转换

## 🔧 技术实现

### 文件结构

```
server/
├── api/
│   └── dify/
│       ├── audit.post.ts          # 创建审计任务
│       └── task/
│           └── [taskId].get.ts    # 查询任务状态
└── utils/
    ├── city-code-map.ts           # 城市编码映射
    ├── task-manager.ts            # 任务管理器
    └── dify-processor.ts          # Dify数据处理核心

components/
├── UploadDialog.vue               # 上传弹窗（已更新）
└── AuditResultTable.vue           # 结果表格

pages/
└── index.vue                      # 主页（已更新，支持轮询）

types/
└── index.ts                       # 类型定义（已更新）
```

### 核心流程

```
1. 用户上传Excel → 解析材料数据
2. 用户配置参数 → 地区、时间、类别
3. 点击"发起审计" → 创建后台任务
4. 返回任务ID → 前端开始轮询
5. 后台处理：
   - 材料分组（每10条一组）
   - 并发调用Dify（最多10组）
   - 实时解析结果
   - 更新任务状态
6. 前端轮询 → 实时显示进度和结果
7. 任务完成 → 停止轮询，显示最终结果
```

## 📊 Dify API对接详情

### 请求格式

```typescript
{
  inputs: {
    city: "4401",  // 城市编码（可选）
    date: "2025-01-01|2025-10-31",  // 时间范围（可选）
    material: "[{\"ID\":\"0001\",\"名称\":\"镀锌圆钢\",\"规格型号\":\"φ10~25\",\"单位\":\"kg\"}]"  // 材料JSON字符串（必填）
  },
  response_mode: "blocking",
  user: "audit_1234567890"
}
```

### 响应格式

```typescript
{
  data: {
    outputs: {
      text: "[{\"id\":\"2298566\",\"name\":\"镀锌圆钢\",\"spec\":\"φ10~25\",\"remark\":\"kg\",\"tax_include_amount\":\"NULL\",\"tax_exclude_amount\":\"4.55\",\"tax_rate\":\"0.00\",\"publish_date\":\"2020年12月\",\"ID\":\"0001\",\"w\":\"1\"}]"
    }
  }
}
```

### 字段映射

| Dify字段 | 说明 | 处理逻辑 |
|---------|------|---------|
| ID | 材料唯一标识 | 用于匹配推送的材料 |
| tax_exclude_amount | 不含税金额 | 优先使用此字段 |
| tax_include_amount | 含税金额 | 如果不含税为空，则用此字段计算 |
| tax_rate | 税率 | 用于含税转不含税，默认13% |

### 价格计算公式

#### 推荐价格范围
```typescript
// 1. 提取所有有效价格
prices = []
for (rec of recommendations) {
  if (rec.tax_exclude_amount 有效) {
    price = rec.tax_exclude_amount
  } else if (rec.tax_include_amount 有效) {
    taxRate = rec.tax_rate || 13
    price = rec.tax_include_amount / (1 + taxRate / 100)
  }
  prices.push(price)
}

// 2. 计算范围
minPrice = Math.min(...prices)
maxPrice = Math.max(...prices)
推荐价格范围 = `${minPrice.toFixed(2)}～${maxPrice.toFixed(2)}`
```

#### 价格偏差
```typescript
if (市场价 < 最小推荐价) {
  偏差 = (最小推荐价 - 市场价) / 市场价 * 100
  显示 = `-${偏差.toFixed(2)}%`
} else if (市场价 > 最大推荐价) {
  偏差 = (市场价 - 最大推荐价) / 市场价 * 100
  显示 = `+${偏差.toFixed(2)}%`
} else {
  显示 = ""  // 在范围内，不显示偏差
}
```

## 🎯 使用流程

### 1. 配置Dify API

在 `.env` 文件中配置：

```env
DIFY_API_KEY=app-xxxxxxxxxxxxxxxxxxxxxxxx
DIFY_API_URL=https://api.dify.ai/v1/workflows/xxxxx/run
```

### 2. 启动系统

```bash
npm run dev
```

### 3. 上传文件

1. 点击"上传文件"按钮
2. 选择Excel文件
3. 点击"下一步"

### 4. 配置参数

- **地区**：选择省或市（可选）
  - 例如：广东省 → 自动转换为编码 `44`
  - 例如：广东省 > 广州市 → 自动转换为编码 `4401`

- **时间范围**：选择月份范围（可选）
  - 例如：2025年01月 至 2025年10月
  - 自动转换为：`2025-01-01|2025-10-31`

- **材料类别**：多选（可选）
  - 如果不选，推送所有材料
  - 如果选择，只推送选中类别的材料

### 5. 发起审计

点击"发起材价审计"按钮：
- 立即返回任务ID
- 显示任务进度卡片
- 开始后台处理

### 6. 查看进度

系统自动每2秒刷新：
- 显示处理进度（0-100%）
- 显示已处理材料数量
- 实时更新结果列表

### 7. 查看结果

任务完成后：
- 显示完整的审计结果列表
- 每条材料显示：
  - 推荐价格范围
  - 价格偏差
  - 查价状态

## 📈 性能特点

### 并发处理
- 每10条材料一组
- 最多10组并发
- 理论最大并发：100条材料同时处理

### 处理时间估算
- 单组Dify调用：约5-15秒
- 100条材料：约15-30秒（10组并发）
- 1000条材料：约2-5分钟（分批并发）

### 后台任务
- 任务创建后立即返回
- 前端可以关闭，后台继续处理
- 任务状态持久化在内存中
- 自动清理24小时前的旧任务

## 🔍 调试信息

### 查看日志

在终端中可以看到详细日志：

```
[TaskManager] 创建任务: task_1234567890_abc, 材料数量: 50
[Dify] 开始处理任务 task_1234567890_abc
[Dify] 按类别筛选后剩余 30 条材料
[Dify] 地区编码: 4401
[Dify] 时间范围: 2025-01-01|2025-10-31
[Dify] 共分为 3 组
[Dify] 调用API: { materialCount: 10, city: '4401', date: '2025-01-01|2025-10-31' }
[Dify] 解析到 15 条推荐数据
[TaskManager] 任务 task_1234567890_abc 添加 10 条结果，总计: 10
[Dify] 任务 task_1234567890_abc 进度: 33%
...
[Dify] 任务 task_1234567890_abc 完成，共处理 30 条结果
```

### 浏览器控制台

按F12打开控制台，可以看到：
- 任务创建信息
- 轮询请求
- 结果更新

## ⚠️ 注意事项

### 1. Excel格式要求
- 第1行：表头
- 数据从第2行开始
- 列顺序：A-B-C-D-E-F-G-H-I-J-K-L
- 编码（B列）必填

### 2. Dify配置
- API密钥必须有效
- 工作流必须已发布
- 输入输出格式必须匹配

### 3. 性能考虑
- 建议单次上传不超过500条材料
- 大批量数据建议分批上传
- 避免频繁创建新任务

### 4. 错误处理
- 如果Dify调用失败，该组材料标记为"查价失败"
- 其他组继续处理，不影响整体流程
- 任务失败后可以重新上传

## 🐛 故障排查

### 问题1：任务一直显示"处理中"

**可能原因**：
- Dify API调用超时
- 网络连接问题
- Dify工作流配置错误

**解决方案**：
1. 检查终端日志，查看具体错误
2. 验证Dify API配置
3. 测试Dify工作流是否正常

### 问题2：价格偏差计算不正确

**可能原因**：
- Dify返回数据格式不符
- tax_exclude_amount和tax_include_amount都为空

**解决方案**：
1. 检查Dify返回的text字段
2. 确认推荐数据包含有效价格
3. 查看浏览器控制台的解析日志

### 问题3：城市编码转换失败

**可能原因**：
- 选择的城市不在映射表中

**解决方案**：
1. 检查 `server/utils/city-code-map.ts`
2. 添加缺失的城市编码
3. 或者不选择地区（留空）

## 📞 技术支持

如有问题，请查看：
1. 终端日志
2. 浏览器控制台
3. Dify工作流运行日志

---

**实现完成时间**: 2024-12-09
**版本**: v1.0.0

