# 材价审计系统 - 腾讯云服务器部署指南

## 📋 前置准备

1. ✅ 已购买腾讯云服务器（建议配置：2核4GB，CentOS 7+ 或 Ubuntu 20.04+）
2. ✅ 已获取服务器公网 IP 和 root 密码
3. ✅ 已配置安全组规则（开放端口：22, 80, 443, 3000）
4. ✅ 代码已推送到 Git 仓库（GitHub/GitLab/Gitee）

---

## 🚀 快速部署（自动化脚本）

### 方式一：使用自动化部署脚本（推荐）

#### 步骤 1: 连接服务器

```bash
# 使用 SSH 连接服务器
ssh root@your-server-ip
# 输入 root 密码
```

#### 步骤 2: 下载部署脚本

在服务器上执行：

```bash
# 创建临时目录
mkdir -p /tmp/deploy
cd /tmp/deploy

# 下载部署脚本（如果代码在 GitHub）
wget https://raw.githubusercontent.com/your-username/your-repo/main/scripts/deploy-tencent.sh
# 或者使用 curl
# curl -O https://raw.githubusercontent.com/your-username/your-repo/main/scripts/deploy-tencent.sh

# 添加执行权限
chmod +x deploy-tencent.sh
```

**或者**，如果你已经在服务器上有项目代码：

```bash
cd /path/to/your/project
chmod +x scripts/deploy-tencent.sh
bash scripts/deploy-tencent.sh
```

#### 步骤 3: 运行部署脚本

```bash
bash deploy-tencent.sh
```

脚本会自动完成：
- ✅ 更新系统
- ✅ 安装 Node.js 18
- ✅ 安装 PM2
- ✅ 安装 Nginx
- ✅ 部署应用代码
- ✅ 构建项目
- ✅ 配置 PM2 自动启动
- ✅ 配置 Nginx 反向代理（可选）
- ✅ 配置防火墙

#### 步骤 4: 配置环境变量

脚本会提示你编辑 `.env` 文件：

```bash
# 编辑环境变量文件
nano /opt/material-audit/.env
```

配置内容：

```env
# Dify API配置
DIFY_API_KEY=app-xxxxxxxxxxxxxxxxxxxxxxxx
DIFY_API_URL=https://api.dify.ai/v1/workflows/your_workflow_id/run

# 数据库配置（如果使用外部数据库）
DB_HOST=your_db_host
DB_PORT=3306
DB_USER=your_db_user
DB_PASSWORD=your_db_password
DB_NAME=your_db_name
```

保存后，重启应用：

```bash
pm2 restart material-audit
```

---

## 🔧 手动部署步骤

如果自动化脚本不适用，可以手动执行以下步骤：

### 1. 连接服务器并更新系统

```bash
ssh root@your-server-ip

# 更新系统
apt-get update -y
apt-get upgrade -y
```

### 2. 安装 Node.js 18

```bash
# 安装 Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt-get install -y nodejs

# 验证安装
node -v  # 应该显示 v18.x.x
npm -v
```

### 3. 安装 PM2

```bash
npm install -g pm2

# 配置 PM2 开机自启
pm2 startup systemd -u root --hp /root
```

### 4. 安装 Nginx（可选）

```bash
apt-get install -y nginx
systemctl enable nginx
systemctl start nginx
```

### 5. 部署应用代码

#### 方式 A: 从 Git 仓库克隆

```bash
# 创建应用目录
mkdir -p /opt/material-audit
cd /opt/material-audit

# 克隆代码（替换为你的仓库地址）
git clone https://github.com/your-username/your-repo.git .

# 或者如果已有代码，直接拉取更新
git pull
```

#### 方式 B: 从本地上传

在本地电脑执行：

```bash
# 打包项目（排除 node_modules）
tar -czf material-audit.tar.gz --exclude='node_modules' --exclude='.git' .

# 上传到服务器
scp material-audit.tar.gz root@your-server-ip:/opt/

# 在服务器上解压
ssh root@your-server-ip
cd /opt
tar -xzf material-audit.tar.gz -C material-audit
```

### 6. 安装依赖和构建

```bash
cd /opt/material-audit

# 安装依赖
npm install

# 配置环境变量
nano .env
# 编辑环境变量（参考上面的配置）

# 构建项目
npm run build
```

### 7. 配置 PM2 启动

创建 PM2 配置文件：

```bash
cat > /opt/material-audit/ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'material-audit',
    script: '.output/server/index.mjs',
    cwd: '/opt/material-audit',
    instances: 1,
    exec_mode: 'fork',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: '/opt/material-audit/logs/pm2-error.log',
    out_file: '/opt/material-audit/logs/pm2-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    autorestart: true,
    max_memory_restart: '500M'
  }]
}
EOF

# 创建日志目录
mkdir -p /opt/material-audit/logs

# 启动应用
pm2 start ecosystem.config.js
pm2 save
```

### 8. 配置 Nginx 反向代理

```bash
# 创建 Nginx 配置
cat > /etc/nginx/sites-available/material-audit << 'EOF'
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名或 IP

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
}
EOF

# 启用站点
ln -s /etc/nginx/sites-available/material-audit /etc/nginx/sites-enabled/

# 测试配置
nginx -t

# 重启 Nginx
systemctl restart nginx
```

### 9. 配置防火墙

#### Ubuntu/Debian (UFW)

```bash
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 3000/tcp
ufw enable
```

#### CentOS (firewalld)

```bash
firewall-cmd --permanent --add-port=22/tcp
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --permanent --add-port=3000/tcp
firewall-cmd --reload
```

### 10. 配置 HTTPS（可选但推荐）

使用 Let's Encrypt 免费 SSL 证书：

```bash
# 安装 Certbot
apt-get install -y certbot python3-certbot-nginx

# 获取证书（替换为你的域名）
certbot --nginx -d your-domain.com

# 自动续期
certbot renew --dry-run
```

---

## 🔍 验证部署

### 检查应用状态

```bash
# 查看 PM2 状态
pm2 status

# 查看应用日志
pm2 logs material-audit

# 查看实时日志
pm2 logs material-audit --lines 50
```

### 测试访问

- **直接访问**: `http://your-server-ip:3000`
- **通过 Nginx**: `http://your-domain.com` 或 `http://your-server-ip`

### 检查端口

```bash
# 检查端口是否监听
netstat -tlnp | grep 3000
# 或
ss -tlnp | grep 3000
```

---

## 📝 常用管理命令

### PM2 管理

```bash
# 查看状态
pm2 status

# 查看日志
pm2 logs material-audit

# 重启应用
pm2 restart material-audit

# 停止应用
pm2 stop material-audit

# 查看详细信息
pm2 info material-audit

# 监控
pm2 monit
```

### 更新应用

使用更新脚本：

```bash
cd /opt/material-audit
bash scripts/update.sh
```

或手动更新：

```bash
cd /opt/material-audit
git pull
npm install
npm run build
pm2 restart material-audit
```

### 查看日志

```bash
# PM2 日志
pm2 logs material-audit

# 应用日志文件
tail -f /opt/material-audit/logs/pm2-out.log
tail -f /opt/material-audit/logs/pm2-error.log

# Nginx 日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

---

## 🔒 安全建议

1. **修改 SSH 端口**（可选）
   ```bash
   nano /etc/ssh/sshd_config
   # 修改 Port 22 为其他端口
   systemctl restart sshd
   ```

2. **禁用 root 登录**（可选）
   ```bash
   # 创建新用户
   adduser deploy
   usermod -aG sudo deploy
   
   # 配置 SSH 密钥登录
   # 然后禁用密码登录
   ```

3. **配置防火墙规则**
   - 只开放必要的端口
   - 限制 SSH 访问 IP（可选）

4. **定期更新系统**
   ```bash
   apt-get update && apt-get upgrade -y
   ```

5. **备份数据**
   ```bash
   # 定期备份应用和数据库
   tar -czf backup-$(date +%Y%m%d).tar.gz /opt/material-audit
   ```

---

## 🐛 故障排查

### 应用无法启动

```bash
# 检查 PM2 日志
pm2 logs material-audit --err

# 检查环境变量
pm2 env material-audit

# 手动启动测试
cd /opt/material-audit
node .output/server/index.mjs
```

### 端口被占用

```bash
# 查找占用端口的进程
lsof -i :3000
# 或
netstat -tlnp | grep 3000

# 杀死进程
kill -9 <PID>
```

### Nginx 502 错误

- 检查应用是否运行：`pm2 status`
- 检查端口是否正确：`netstat -tlnp | grep 3000`
- 检查 Nginx 配置：`nginx -t`

### 数据库连接失败

- 检查数据库是否允许外部连接
- 检查防火墙规则
- 检查环境变量配置

---

## 📞 获取帮助

如果遇到问题：

1. 查看应用日志：`pm2 logs material-audit`
2. 查看系统日志：`journalctl -u nginx`
3. 检查服务器资源：`htop` 或 `free -h`

---

## ✅ 部署检查清单

- [ ] 服务器已连接
- [ ] Node.js 18+ 已安装
- [ ] PM2 已安装并配置
- [ ] 代码已部署到服务器
- [ ] 环境变量已配置
- [ ] 应用已构建成功
- [ ] PM2 已启动应用
- [ ] Nginx 已配置（如使用）
- [ ] 防火墙已配置
- [ ] 可以正常访问应用

---

**部署完成后，你的系统就可以通过 `http://your-server-ip:3000` 或 `http://your-domain.com` 访问了！** 🎉

