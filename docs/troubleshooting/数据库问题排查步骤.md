# 数据库问题排查步骤

## 当前配置
- 数据库名：`myapp` ✅
- 数据库地址：`gz-cdb-gaxrunxl.sql.tencentcdb.com`
- 端口：`28544`

## 排查步骤

### 步骤 1: 验证表是否存在

在腾讯云控制台的 SQL 窗口中执行：

```sql
USE myapp;
SHOW TABLES;
```

**应该看到三个表**：
- `audit_tasks`
- `audit_materials`
- `audit_results`

**如果没有看到这些表**：
1. 确认你选择的是 `myapp` 数据库
2. 重新执行 `database/schema.sql` 文件中的 SQL

### 步骤 2: 检查表结构

执行以下 SQL 检查表结构是否正确：

```sql
USE myapp;
DESCRIBE audit_tasks;
DESCRIBE audit_materials;
DESCRIBE audit_results;
```

**关键字段检查**：
- `audit_tasks` 表应该有：`task_id`, `project_name`, `status`, `progress`, `total_materials`, `created_at`, `updated_at`
- `audit_materials` 表应该有：`task_id`, `material_id`, `data`
- `audit_results` 表应该有：`task_id`, `material_id`, `data`

### 步骤 3: 测试查询

执行以下 SQL，模拟系统查询：

```sql
USE myapp;
SELECT t.*, 
 (SELECT COUNT(*) FROM audit_results WHERE task_id = t.task_id) as result_count
 FROM audit_tasks t 
 ORDER BY t.created_at DESC;
```

**如果这个查询能正常执行**，说明表结构正确。

**如果报错**，请告诉我具体的错误信息。

### 步骤 4: 检查服务器日志

查看运行 `npm run dev` 的终端窗口，查找：
- `[TaskManager] 列出任务失败` 的错误
- 具体的 SQL 错误信息

### 步骤 5: 重启服务器

如果修改了配置或表结构，必须重启服务器：

```bash
# 停止服务器（Ctrl + C）
# 然后重新启动
npm run dev
```

## 常见问题

### Q1: 表存在但查询还是报错

**可能原因**：
- 字段名不匹配
- 表结构不完整

**解决方案**：
1. 检查表结构是否与 `schema.sql` 一致
2. 如果表结构不对，删除表后重新创建：
   ```sql
   USE myapp;
   DROP TABLE IF EXISTS audit_results;
   DROP TABLE IF EXISTS audit_materials;
   DROP TABLE IF EXISTS audit_tasks;
   ```
   然后重新执行 `database/schema.sql`

### Q2: 查询返回空结果但系统报错

**可能原因**：
- 数据库连接问题
- 权限问题

**解决方案**：
1. 访问健康检查页面：`http://localhost:3000/health`
2. 查看连接检查结果

### Q3: 如何确认问题出在哪里？

**检查顺序**：
1. ✅ 数据库名是否正确（已确认：`myapp`）
2. ✅ 表是否存在（需要验证）
3. ✅ 表结构是否正确（需要验证）
4. ✅ 查询是否能执行（需要验证）
5. ✅ 服务器日志中的错误信息

## 需要你提供的信息

请执行以下 SQL 并告诉我结果：

```sql
USE myapp;
SHOW TABLES;
```

以及：

```sql
USE myapp;
SELECT t.*, 
 (SELECT COUNT(*) FROM audit_results WHERE task_id = t.task_id) as result_count
 FROM audit_tasks t 
 ORDER BY t.created_at DESC;
```

如果 SQL 执行报错，请把错误信息发给我。

