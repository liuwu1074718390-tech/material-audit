# Dify 接入详细步骤指南

## 📋 目录

1. [注册Dify账号](#步骤1注册dify账号)
2. [创建工作流](#步骤2创建工作流)
3. [配置输入节点](#步骤3配置输入节点)
4. [设计工作流逻辑](#步骤4设计工作流逻辑)
5. [配置输出节点](#步骤5配置输出节点)
6. [测试工作流](#步骤6测试工作流)
7. [发布工作流](#步骤7发布工作流)
8. [获取API密钥](#步骤8获取api密钥)
9. [配置到项目](#步骤9配置到项目)
10. [测试接入](#步骤10测试接入)

---

## 步骤1：注册Dify账号

### 1.1 访问Dify官网

打开浏览器，访问：
```
https://dify.ai
```

或者使用国内版本：
```
https://cloud.dify.ai
```

### 1.2 注册账号

1. 点击右上角 **"Sign Up"** 或 **"注册"**
2. 选择注册方式：
   - 邮箱注册
   - GitHub账号
   - Google账号
3. 填写信息并完成注册
4. 验证邮箱（如果使用邮箱注册）

### 1.3 登录

注册完成后，使用账号登录Dify平台。

---

## 步骤2：创建工作流

### 2.1 进入工作区

登录后，您会看到Dify的主界面。

### 2.2 创建新的工作流

1. 点击 **"创建应用"** 或 **"Create App"**
2. 选择 **"工作流"** (Workflow) 类型
3. 输入应用名称：`材价审计工作流`
4. 输入描述：`用于分析材料价格并给出审计建议`
5. 点击 **"创建"**

---

## 步骤3：配置输入节点

工作流创建后，会自动打开工作流编辑器。

### 3.1 找到"开始"节点

在工作流画布左侧，应该有一个 **"开始"** 或 **"Start"** 节点。

### 3.2 配置输入变量

点击"开始"节点，在右侧配置面板中添加以下输入变量：

#### 变量1：materials（必填）
```
变量名：materials
类型：Text（文本）
描述：材料数据JSON字符串
必填：是
```

#### 变量2：region（选填）
```
变量名：region
类型：Text（文本）
描述：地区信息（如：广东省-广州市）
必填：否
默认值：（留空）
```

#### 变量3：timeRange（选填）
```
变量名：timeRange
类型：Text（文本）
描述：时间范围（如：2024-01 至 2024-12）
必填：否
默认值：（留空）
```

#### 变量4：categories（选填）
```
变量名：categories
类型：Text（文本）
描述：选择的类别（逗号分隔）
必填：否
默认值：（留空）
```

---

## 步骤4：设计工作流逻辑

现在开始设计工作流的处理逻辑。以下是推荐的节点结构：

### 4.1 添加"代码"节点 - 解析材料数据

1. 在画布中点击 **"+"** 添加节点
2. 选择 **"代码"** 节点
3. 命名为：`解析材料数据`
4. 输入以下Python代码：

```python
import json

def main(materials: str) -> dict:
    """解析材料数据"""
    try:
        # 解析JSON字符串
        materials_list = json.loads(materials)
        
        # 提取关键信息
        result = {
            "total_count": len(materials_list),
            "materials": materials_list,
            "categories": list(set([m.get("类别", "") for m in materials_list if m.get("类别")]))
        }
        
        return result
    except Exception as e:
        return {
            "error": str(e),
            "total_count": 0,
            "materials": [],
            "categories": []
        }
```

5. 配置输入：
   - `materials`: 连接到开始节点的 `materials` 变量

### 4.2 添加"LLM"节点 - AI分析

1. 添加 **"LLM"** 节点
2. 命名为：`价格分析`
3. 选择模型：推荐使用 **GPT-4** 或 **Claude-3**
4. 配置提示词（Prompt）：

```
你是一个专业的建材价格审计专家。请分析以下材料的价格合理性。

# 材料数据
{{#解析材料数据.materials}}
- 编码：{{编码}}
- 名称：{{名称}}
- 规格：{{规格型号}}
- 单位：{{单位}}
- 数量：{{数量}}
- 不含税市场价：{{不含税市场价}} 元/{{单位}}
{{/解析材料数据.materials}}

# 分析条件
地区：{{#region}}{{region}}{{/region}}{{^region}}全国{{/region}}
时间范围：{{#timeRange}}{{timeRange}}{{/timeRange}}{{^timeRange}}当前{{/timeRange}}
关注类别：{{#categories}}{{categories}}{{/categories}}{{^categories}}全部{{/categories}}

# 任务要求
对每个材料，请提供：
1. 基于地区和时间的推荐价格范围（不含税）
2. 价格偏差百分比（相对于推荐价格平均值）

# 输出格式（严格JSON）
请以JSON数组格式输出，每个元素包含：
{
  "序号": 材料序号,
  "编码": "材料编码",
  "推荐价格范围": "最低价 - 最高价",
  "价格偏差": "+X%或-X%"
}

示例：
[
  {
    "序号": 1,
    "编码": "010101001001",
    "推荐价格范围": "3800 - 4100",
    "价格偏差": "+5.26%"
  }
]

请直接输出JSON数组，不要添加任何其他文字说明。
```

5. 配置输入：
   - `解析材料数据.materials`: 材料列表
   - `region`: 开始节点的 region
   - `timeRange`: 开始节点的 timeRange
   - `categories`: 开始节点的 categories

### 4.3 添加"代码"节点 - 格式化输出

1. 添加 **"代码"** 节点
2. 命名为：`格式化结果`
3. 输入以下Python代码：

```python
import json
import re

def main(llm_output: str) -> dict:
    """格式化LLM输出为标准格式"""
    try:
        # 尝试提取JSON数组
        # 移除可能的markdown代码块标记
        cleaned = re.sub(r'```json\s*|\s*```', '', llm_output)
        cleaned = cleaned.strip()
        
        # 解析JSON
        results = json.loads(cleaned)
        
        # 确保是数组
        if not isinstance(results, list):
            results = [results]
        
        return {
            "results": results
        }
    except Exception as e:
        # 如果解析失败，返回空结果
        return {
            "results": [],
            "error": str(e)
        }
```

4. 配置输入：
   - `llm_output`: 连接到"价格分析"节点的输出

---

## 步骤5：配置输出节点

### 5.1 找到"结束"节点

在工作流画布右侧，应该有一个 **"结束"** 或 **"End"** 节点。

### 5.2 配置输出变量

点击"结束"节点，配置输出：

```
输出变量名：results
来源：格式化结果.results
类型：Array
```

---

## 步骤6：测试工作流

### 6.1 准备测试数据

点击工作流右上角的 **"运行"** 或 **"Test"** 按钮。

在测试面板中输入测试数据：

```json
{
  "materials": "[{\"序号\":1,\"编码\":\"010101001001\",\"类别\":\"钢筋\",\"名称\":\"热轧带肋钢筋\",\"规格型号\":\"HRB400 Φ12\",\"单位\":\"t\",\"数量\":10.5,\"不含税市场价\":4200,\"税率\":13}]",
  "region": "广东省-广州市",
  "timeRange": "2024-01 至 2024-12",
  "categories": "钢筋"
}
```

### 6.2 运行测试

1. 点击 **"运行"** 按钮
2. 观察每个节点的执行情况
3. 查看输出结果

### 6.3 验证输出

确保输出格式正确：

```json
{
  "results": [
    {
      "序号": 1,
      "编码": "010101001001",
      "推荐价格范围": "3800 - 4100",
      "价格偏差": "+5.26%"
    }
  ]
}
```

---

## 步骤7：发布工作流

### 7.1 保存工作流

点击右上角的 **"保存"** 按钮。

### 7.2 发布工作流

1. 点击 **"发布"** 按钮
2. 选择 **"发布为API"**
3. 确认发布

---

## 步骤8：获取API密钥

### 8.1 进入API设置

发布后，点击 **"API访问"** 或 **"API Access"** 标签。

### 8.2 创建API密钥

1. 点击 **"创建密钥"** 或 **"Create API Key"**
2. 输入密钥名称：`材价审计系统`
3. 点击 **"创建"**
4. **重要**：立即复制API密钥，格式类似：
   ```
   app-xxxxxxxxxxxxxxxxxxxxxxxx
   ```
   ⚠️ 密钥只显示一次，请妥善保存！

### 8.3 获取工作流URL

在API访问页面，找到 **"API端点"** 或 **"API Endpoint"**，格式类似：
```
https://api.dify.ai/v1/workflows/{workflow_id}/run
```

复制这个完整的URL。

---

## 步骤9：配置到项目

### 9.1 打开项目配置文件

在终端中运行：

```bash
cd /Users/liuwu/Desktop/材价审计
open .env
```

如果 `.env` 文件不存在，创建它：

```bash
cp .env.example .env
open .env
```

### 9.2 填入配置

在 `.env` 文件中填入您刚才获取的信息：

```env
# Dify API配置
DIFY_API_KEY=app-xxxxxxxxxxxxxxxxxxxxxxxx
DIFY_API_URL=https://api.dify.ai/v1/workflows/your_workflow_id/run
```

**替换说明**：
- `app-xxxxxxxxxxxxxxxxxxxxxxxx` → 替换为您的实际API密钥
- `your_workflow_id` → 替换为您的实际工作流ID

### 9.3 保存文件

保存 `.env` 文件并关闭。

### 9.4 重启开发服务器

在终端中：

1. 按 `Ctrl + C` 停止当前服务器
2. 重新启动：
   ```bash
   npm run dev
   ```

---

## 步骤10：测试接入

### 10.1 打开系统

在浏览器中访问：http://localhost:3000

### 10.2 上传测试文件

1. 点击 **"上传文件"** 按钮
2. 选择示例文件：
   ```
   上传材料/华工二期2025-10-12V2（控制价终稿）备案-人材机汇总.xls
   ```
3. 点击 **"下一步"**

### 10.3 配置参数

1. 地区：选择 **"广东省 > 广州市"**
2. 时间：选择 **"2024-01 至 2024-12"**
3. 类别：选择几个类别（可选）

### 10.4 发起审计

1. 点击 **"发起材价审计"** 按钮
2. 等待处理（可能需要10-30秒）
3. 查看审计结果

### 10.5 验证结果

确认结果列表中显示：
- ✅ 推荐价格范围
- ✅ 价格偏差
- ✅ 价格偏差颜色标识

---

## 🎉 完成！

如果看到审计结果，说明Dify接入成功！

---

## ❓ 常见问题

### Q1: API调用失败

**检查项**：
1. API密钥是否正确复制（包含 `app-` 前缀）
2. 工作流URL是否完整
3. 工作流是否已发布
4. 网络连接是否正常

**解决方案**：
```bash
# 查看服务器日志
# 在终端中会显示错误信息
```

### Q2: 返回结果格式不对

**原因**：LLM输出格式不符合要求

**解决方案**：
1. 在Dify中测试工作流
2. 检查"格式化结果"节点的输出
3. 调整LLM的提示词，强调JSON格式

### Q3: 处理速度慢

**原因**：
- LLM处理需要时间
- 材料数据量大

**优化建议**：
1. 使用更快的模型（如GPT-3.5）
2. 分批处理材料
3. 使用流式输出（streaming）

### Q4: 开发模式下使用模拟数据

**说明**：
如果Dify未配置或调用失败，系统会自动使用模拟数据，这是正常的。

**查看日志**：
在浏览器控制台（F12）可以看到：
```
开发模式：使用模拟数据
```

---

## 📞 需要帮助？

如果遇到问题：

1. 查看浏览器控制台（F12）的错误信息
2. 查看终端的服务器日志
3. 查看Dify工作流的运行日志
4. 参考 `docs/DIFY_INTEGRATION.md` 获取更多信息

---

**祝您接入顺利！** 🚀

