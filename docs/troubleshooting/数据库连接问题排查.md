# 数据库连接超时问题排查指南

## 问题说明
出现 `ETIMEDOUT` 错误，说明系统无法连接到数据库服务器。这通常是网络配置问题。

## 排查步骤

### 步骤 1: 确认你的服务器位置

**重要问题**：你的服务器在哪里运行？

- **选项 A**：在本地电脑（Mac）上运行
  - 需要使用**外网地址**连接腾讯云数据库
  - 需要确保腾讯云数据库开启了**外网访问**

- **选项 B**：在腾讯云服务器上运行
  - 可以使用**内网地址**（更快、免费）
  - 也可以使用外网地址

### 步骤 2: 检查数据库地址类型

在腾讯云控制台的数据库实例详情页，你会看到两种地址：

1. **内网地址**（格式：`10.x.x.x` 或 `172.x.x.x`）
   - 只能在腾讯云内网使用
   - 本地电脑无法连接

2. **外网地址**（格式：`xxx.sql.tencentcdb.com` 或 `xxx.tencentcdb.com`）
   - 可以从任何地方连接
   - 需要开启外网访问功能

### 步骤 3: 根据服务器位置选择地址

#### 情况 A：服务器在本地电脑（Mac）

**必须使用外网地址**：

1. **检查外网访问是否开启**：
   - 登录腾讯云控制台
   - 进入数据库实例详情页
   - 查看"外网地址"部分
   - 如果没有外网地址，需要开启外网访问

2. **开启外网访问**（如果未开启）：
   - 在数据库实例详情页
   - 找到"外网地址"或"网络"设置
   - 点击"开启外网访问"
   - 等待几分钟生效

3. **获取外网地址**：
   - 外网地址格式：`gz-cdb-xxxxx.sql.tencentcdb.com:端口`
   - 复制完整的外网地址（包括端口）

4. **更新 .env 文件**：
   ```env
   DB_HOST=gz-cdb-xxxxx.sql.tencentcdb.com
   DB_PORT=3306
   ```

#### 情况 B：服务器在腾讯云上

**优先使用内网地址**：

1. **获取内网地址**：
   - 在数据库实例详情页找到"内网地址"
   - 格式：`10.x.x.x` 或 `172.x.x.x`

2. **更新 .env 文件**：
   ```env
   DB_HOST=10.x.x.x
   DB_PORT=3306
   ```

### 步骤 4: 检查安全组设置

如果使用外网访问，需要确保安全组允许连接：

1. **进入安全组设置**：
   - 在数据库实例详情页
   - 找到"安全组"或"网络"设置

2. **添加规则**：
   - 协议：`TCP`
   - 端口：`3306`
   - 来源：`0.0.0.0/0`（允许所有IP，或指定你的IP）

### 步骤 5: 测试数据库连接

#### 方法 1: 使用命令行测试（推荐）

在终端运行：

```bash
# 测试连接（需要先安装 mysql 客户端）
mysql -h 你的数据库地址 -P 3306 -u 你的用户名 -p
```

如果连接成功，说明地址和网络没问题。

#### 方法 2: 使用健康检查页面

1. 更新 `.env` 文件后
2. 重启服务器：`npm run dev`
3. 访问：`http://localhost:3000/health`
4. 查看连接检查结果

### 步骤 6: 常见问题解决

#### 问题 1: 外网地址显示"未开启"

**解决方案**：
1. 在腾讯云控制台开启外网访问
2. 等待几分钟生效
3. 重新获取外网地址

#### 问题 2: 连接被拒绝（不是超时）

**可能原因**：
- 安全组未开放 3306 端口
- IP 地址被限制

**解决方案**：
1. 检查安全组规则
2. 添加允许规则

#### 问题 3: 地址格式错误

**正确格式**：
- 内网：`10.1.2.3`（纯IP，不要加端口）
- 外网：`gz-cdb-xxxxx.sql.tencentcdb.com`（域名，不要加端口）

**错误格式**：
- ❌ `10.1.2.3:3306`（内网地址不要加端口）
- ❌ `gz-cdb-xxxxx.sql.tencentcdb.com:3306`（域名不要加端口）

端口在 `DB_PORT` 中单独配置。

## 快速检查清单

- [ ] 确认服务器位置（本地/腾讯云）
- [ ] 选择正确的地址类型（内网/外网）
- [ ] 外网访问已开启（如果使用外网）
- [ ] 安全组已开放 3306 端口
- [ ] `.env` 文件中的地址格式正确
- [ ] 已重启服务器
- [ ] 使用健康检查页面验证

## 需要帮助？

如果按照以上步骤操作后仍然无法连接，请提供：

1. 你的服务器运行位置（本地 Mac / 腾讯云服务器）
2. 使用的地址类型（内网地址 / 外网地址）
3. 完整的错误信息（从健康检查页面复制）
4. 数据库地址格式（隐藏敏感部分）

我会根据具体情况帮你进一步排查。

