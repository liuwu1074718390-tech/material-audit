# Dify对接功能测试指南

## 🎯 测试前准备

### 1. 确认环境配置

```bash
# 检查.env文件
cat .env
```

应该包含：
```env
DIFY_API_KEY=app-xxxxxxxxxxxxxxxxxxxxxxxx
DIFY_API_URL=https://api.dify.ai/v1/workflows/xxxxx/run
```

### 2. 启动开发服务器

```bash
cd /Users/liuwu/Desktop/材价审计
npm run dev
```

等待启动完成，看到：
```
✓ Vite server built
✓ Nuxt Nitro server built
ℹ Vite client warmed up
```

### 3. 打开浏览器

访问：http://localhost:3000

---

## 📝 功能测试清单

### 测试1：基础上传和解析 ✅

**步骤**：
1. 点击"上传文件"按钮
2. 选择示例文件：`上传材料/华工二期2025-10-12V2（控制价终稿）备案-人材机汇总.xls`
3. 点击"下一步"

**预期结果**：
- ✅ 文件上传成功
- ✅ 显示"已解析 XXX 条材料数据"
- ✅ 类别下拉框显示正确的类别（不是编码）

---

### 测试2：地区选择和编码转换 ✅

**步骤**：
1. 在参数配置页面，点击"地区"下拉框
2. 测试只选择省：选择"广东省"
3. 测试选择市：选择"广东省 > 广州市"

**预期结果**：
- ✅ 可以只选择省份
- ✅ 也可以选择具体城市
- ✅ 选择后可以确定

**验证编码转换**：
打开浏览器控制台（F12），在发起审计时应该看到：
```
[Dify] 地区编码: 44  （如果只选择广东省）
[Dify] 地区编码: 4401  （如果选择广州市）
```

---

### 测试3：时间范围格式化 ✅

**步骤**：
1. 点击"时间范围"选择器
2. 选择：2025年01月 至 2025年10月

**预期结果**：
- ✅ 显示格式为："2025年01月 至 2025年10月"（中文）
- ✅ 在控制台看到转换后的格式：`2025-01-01|2025-10-31`

---

### 测试4：类别筛选 ✅

**步骤**：
1. 在"材料类别"下拉框中选择几个类别
2. 例如：选择"钢筋"和"水泥"

**预期结果**：
- ✅ 可以多选
- ✅ 显示已选择的标签
- ✅ 在控制台看到：`[Dify] 按类别筛选后剩余 XX 条材料`

---

### 测试5：任务创建和后台处理 ✅

**步骤**：
1. 配置好参数（地区、时间、类别可选）
2. 点击"发起材价审计"按钮
3. 观察页面变化

**预期结果**：
- ✅ 立即显示"审计任务已创建，正在后台处理..."
- ✅ 弹窗关闭
- ✅ 主页显示"当前审计任务"卡片
- ✅ 显示进度条（0%开始）

**控制台日志**：
```
[TaskManager] 创建任务: task_xxxxx, 材料数量: XX
[Dify] 开始处理任务 task_xxxxx
[Dify] 共分为 X 组
```

---

### 测试6：实时进度更新 ✅

**步骤**：
1. 任务创建后，观察进度卡片
2. 等待几秒钟

**预期结果**：
- ✅ 进度条自动更新（0% → 33% → 66% → 100%）
- ✅ "已处理"数量实时增加
- ✅ 状态标签显示"处理中"（黄色）
- ✅ 每2秒自动刷新

**控制台日志**：
```
[Dify] 任务 task_xxxxx 进度: 33%
[Dify] 任务 task_xxxxx 进度: 66%
[Dify] 任务 task_xxxxx 进度: 100%
```

---

### 测试7：结果实时显示 ✅

**步骤**：
1. 在任务处理过程中，观察下方的"审计结果"表格
2. 表格应该逐渐填充数据

**预期结果**：
- ✅ 表格实时显示新增的结果
- ✅ 每条材料显示：
  - 序号、编码、类别、名称等基本信息
  - 推荐价格范围（格式：10.38～15.64）
  - 价格偏差（格式：+5.26% 或 -3.14%）
  - 价格偏差有颜色标识（红/绿/黄）

---

### 测试8：任务完成 ✅

**步骤**：
1. 等待任务完成（进度达到100%）
2. 观察状态变化

**预期结果**：
- ✅ 进度条变绿
- ✅ 状态标签变为"已完成"（绿色）
- ✅ 停止轮询（控制台不再有请求）
- ✅ 显示成功提示："审计完成！"
- ✅ 所有结果都已显示在表格中

---

### 测试9：结果筛选和导出 ✅

**步骤**：
1. 在结果表格上方使用筛选器
2. 测试各种筛选条件：
   - 按编码筛选
   - 按类别筛选
   - 按价格偏差筛选（偏高/正常/偏低）
3. 点击"导出Excel"按钮

**预期结果**：
- ✅ 筛选功能正常工作
- ✅ 表格实时更新
- ✅ 导出Excel文件成功
- ✅ 导出的文件包含所有字段

---

### 测试10：并发处理（压力测试）

**步骤**：
1. 上传包含100+条材料的Excel文件
2. 发起审计
3. 观察处理过程

**预期结果**：
- ✅ 系统自动分组（每10条一组）
- ✅ 并发处理多组（最多10组）
- ✅ 进度平滑更新
- ✅ 所有材料都被处理

**控制台日志**：
```
[Dify] 共分为 12 组
[Dify] 调用API: { materialCount: 10, ... }
[Dify] 调用API: { materialCount: 10, ... }
...（最多10个并发）
```

---

### 测试11：错误处理

**步骤**：
1. 测试Dify API配置错误的情况
2. 临时修改.env中的API密钥为错误值
3. 重启服务器，发起审计

**预期结果**：
- ✅ 显示错误提示
- ✅ 任务状态变为"失败"
- ✅ 不会导致系统崩溃

---

### 测试12：前端关闭后继续处理

**步骤**：
1. 发起一个审计任务
2. 立即关闭浏览器标签页
3. 等待30秒
4. 重新打开页面

**预期结果**：
- ✅ 后台任务继续处理（查看终端日志）
- ✅ 重新打开页面后，可以通过任务ID查询结果

**注意**：当前版本任务ID不会自动保存，需要手动记录。

---

## 🔍 详细验证点

### 1. 城市编码转换验证

在终端日志中查找：

```bash
# 应该看到类似输出
[Dify] 地区编码: 44      # 广东省
[Dify] 地区编码: 4401    # 广州市
[Dify] 地区编码: 11      # 北京市
[Dify] 地区编码: 31      # 上海市
```

### 2. 时间格式转换验证

```bash
# 输入: 2025年01月 至 2025年10月
# 输出: 2025-01-01|2025-10-31

# 输入: 2024年02月 至 2024年02月
# 输出: 2024-02-01|2024-02-29  （闰年）
```

### 3. 材料ID生成验证

在控制台查看发送给Dify的数据：

```json
[
  {"ID":"0001","名称":"镀锌圆钢","规格型号":"φ10~25","单位":"kg"},
  {"ID":"0002","名称":"水泥","规格型号":"P.O 42.5","单位":"t"},
  {"ID":"0003","名称":"混凝土","规格型号":"C30","单位":"m³"}
]
```

### 4. 价格计算验证

**示例1：不含税价格直接使用**
```
Dify返回: tax_exclude_amount = "4.55"
推荐价格: 4.55
```

**示例2：含税价格转换**
```
Dify返回: 
  tax_include_amount = "5.00"
  tax_rate = "13"
计算: 5.00 / (1 + 13/100) = 4.42
推荐价格: 4.42
```

**示例3：价格偏差计算**
```
市场价: 4200
推荐范围: 3800～4100
最大值: 4100
偏差: (4200 - 4100) / 4200 * 100 = 2.38%
显示: +2.38%
```

---

## 📊 性能基准

### 预期处理时间

| 材料数量 | 分组数 | 预计时间 | 说明 |
|---------|--------|---------|------|
| 10条 | 1组 | 5-15秒 | 单组处理 |
| 50条 | 5组 | 15-30秒 | 5组并发 |
| 100条 | 10组 | 15-30秒 | 10组并发（最大） |
| 200条 | 20组 | 30-60秒 | 分2批，每批10组 |
| 500条 | 50组 | 2-5分钟 | 分5批处理 |

---

## ⚠️ 已知限制

1. **任务持久化**：任务存储在内存中，服务器重启后丢失
2. **历史记录**：当前版本不保存历史任务
3. **并发限制**：最多10组并发，超过需要排队
4. **文件大小**：建议单次不超过500条材料

---

## 🐛 常见问题

### Q1: 进度一直是0%

**原因**：Dify API调用失败

**排查**：
1. 检查.env配置
2. 查看终端错误日志
3. 测试Dify工作流

### Q2: 类别显示为编码

**原因**：Excel解析列位置错误

**解决**：已修复，C列为类别

### Q3: 价格偏差计算不对

**原因**：Dify返回数据格式问题

**排查**：
1. 查看Dify返回的text字段
2. 确认包含有效的价格数据

---

## ✅ 测试通过标准

全部测试项目通过，且：

- ✅ 无JavaScript错误
- ✅ 无控制台警告
- ✅ 终端无错误日志
- ✅ 结果数据正确
- ✅ 价格计算准确
- ✅ 性能符合预期

---

**测试完成后，请将结果反馈给开发团队！**

