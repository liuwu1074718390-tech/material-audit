# 🔧 数据库连接超时问题解决

## 问题诊断

错误信息：`connect ETIMEDOUT`

这说明 Vercel 无法连接到你的数据库服务器。虽然本地可以连接，但 Vercel 运行在云端，需要通过公网访问。

## 🔍 可能的原因

1. **数据库安全组未配置** - Vercel 的 IP 被阻止
2. **外网访问未开启** - 数据库只允许内网访问
3. **网络路由问题** - Vercel 无法路由到数据库服务器

## ✅ 解决步骤

### 步骤 1: 确认数据库外网访问已开启

1. **登录腾讯云控制台**
   - 进入云数据库 MySQL
   - 找到你的数据库实例

2. **检查外网访问状态**
   - 查看实例详情
   - 确认 **"外网地址"** 是否已开启
   - 如果未开启，点击 **"开启外网访问"**

3. **记录外网地址和端口**
   - 外网地址：应该类似 `gz-cdb-xxx.sql.tencentcdb.com`
   - 外网端口：通常是 `28544` 或其他端口（不是 3306）

### 步骤 2: 配置数据库安全组

这是**最关键的一步**！

1. **进入安全组设置**
   - 在数据库实例详情页
   - 点击 **"安全组"** 或 **"数据库访问"**
   - 或者进入 **"数据安全"** → **"白名单"**

2. **添加允许规则**

   **方式一：临时测试（允许所有 IP）**
   - 添加规则：`0.0.0.0/0`（允许所有 IP）
   - 端口：`28544`（你的外网端口）
   - 协议：TCP

   ⚠️ **注意**：这会让数据库暴露在公网，仅用于测试。生产环境应该限制 IP。

   **方式二：添加 Vercel IP 范围（推荐）**
   
   Vercel 的 IP 是动态的，但你可以：
   - 临时使用 `0.0.0.0/0` 测试
   - 或者查看 Vercel 函数执行的 IP（从日志中获取）
   - 或者在腾讯云数据库控制台查看"连接来源"了解当前连接的 IP

3. **应用安全组规则**
   - 保存规则
   - 等待几分钟让规则生效

### 步骤 3: 验证连接

在 Vercel 部署中访问诊断接口：
```
https://你的vercel地址.vercel.app/api/health/db-check
```

如果仍然超时，检查：
- 安全组规则是否已生效（可能需要等待几分钟）
- 外网端口是否正确（28544）
- 数据库实例是否正常运行

## 📋 快速检查清单

- [ ] 数据库外网访问已开启
- [ ] 记录了正确的外网地址和端口
- [ ] 安全组已添加允许规则（至少 `0.0.0.0/0` 用于测试）
- [ ] 安全组规则已应用到数据库实例
- [ ] 等待了 2-3 分钟让规则生效
- [ ] 访问诊断接口验证连接

## 🔒 安全建议

**测试完成后，建议**：
1. 限制安全组，只允许特定 IP 访问
2. 使用数据库代理服务（如腾讯云 DCDB Proxy）
3. 考虑使用 Vercel 的数据库服务（如 Vercel Postgres）

## 💡 替代方案

如果仍然无法连接，可以考虑：

1. **使用 PlanetScale**（推荐）
   - 专门为无服务器环境设计
   - 自动处理连接问题
   - 免费额度充足

2. **使用腾讯云 DCDB Proxy**
   - 数据库代理服务
   - 更好地支持外网访问

3. **使用 Vercel Postgres**
   - Vercel 内置数据库
   - 无缝集成
   - 需要迁移数据

## 🆘 仍然有问题？

如果按照上述步骤操作后仍然超时：

1. 检查腾讯云数据库实例的状态（是否正常运行）
2. 查看数据库连接日志（腾讯云控制台）
3. 尝试从其他位置（如本地）连接外网地址测试
4. 联系腾讯云技术支持




