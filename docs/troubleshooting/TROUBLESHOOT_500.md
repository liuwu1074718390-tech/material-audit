# 500 内部服务器错误排查指南

## 🔍 快速诊断步骤

### 1. 查看服务器终端输出

在运行 `npm run dev` 的终端中，查看是否有错误信息。常见错误包括：

- 数据库连接失败
- 环境变量未配置
- 插件加载错误
- 模块导入错误

### 2. 检查浏览器控制台

1. 打开浏览器开发者工具（F12 或 Cmd+Option+I）
2. 查看 **Console** 标签中的错误信息
3. 查看 **Network** 标签，点击失败的请求查看详细错误

### 3. 检查环境变量

确保 `.env` 文件存在且配置正确：

```bash
# 检查 .env 文件
cat .env

# 应该包含：
# DIFY_API_KEY=...
# DIFY_API_URL=...
# DIFY_WORKFLOW_ID=...
# DB_HOST=...
# DB_PORT=...
# DB_USER=...
# DB_PASSWORD=...
# DB_NAME=...
```

### 4. 测试 API 端点

在浏览器中访问以下 URL 来诊断问题：

- **健康检查**: `http://localhost:3000/api/health/db`
- **数据库检查**: `http://localhost:3000/api/health/db-check`
- **任务列表**: `http://localhost:3000/api/dify/tasks`

## 🛠️ 常见问题和解决方案

### 问题 1: 数据库连接失败

**症状**: 500 错误，终端显示数据库连接错误

**解决方案**:
1. 检查 `.env` 文件中的数据库配置
2. 确保数据库服务正在运行
3. 测试数据库连接：
   ```bash
   mysql -h <DB_HOST> -P <DB_PORT> -u <DB_USER> -p
   ```

### 问题 2: 环境变量未配置

**症状**: 500 错误，终端显示 "undefined" 或配置相关错误

**解决方案**:
1. 创建 `.env` 文件（如果不存在）
2. 填入所有必需的环境变量
3. 重启开发服务器

### 问题 3: 插件加载错误

**症状**: 500 错误，终端显示插件相关错误

**解决方案**:
1. 检查 `plugins/element-plus.ts` 文件是否有语法错误
2. 清理缓存并重启：
   ```bash
   rm -rf .nuxt
   npm run dev
   ```

### 问题 4: 模块导入错误

**症状**: 500 错误，终端显示 "Cannot find module" 或导入错误

**解决方案**:
1. 重新安装依赖：
   ```bash
   rm -rf node_modules package-lock.json
   npm install --legacy-peer-deps
   ```
2. 检查导入路径是否正确

## 🔧 详细排查步骤

### 步骤 1: 重启开发服务器

```bash
# 停止当前服务器（Ctrl + C）
# 然后重新启动
npm run dev
```

### 步骤 2: 清理缓存

```bash
# 清理 Nuxt 缓存
rm -rf .nuxt

# 重新启动
npm run dev
```

### 步骤 3: 检查服务器日志

查看终端输出，寻找：
- 红色错误信息
- 堆栈跟踪（stack trace）
- 数据库连接错误
- 模块加载错误

### 步骤 4: 测试最小配置

如果问题持续，尝试最小配置：

1. 临时禁用数据库相关功能
2. 检查是否仍然出现 500 错误
3. 逐步启用功能，找出问题所在

## 💡 获取详细错误信息

### 方法 1: 查看终端输出

开发服务器会在终端显示详细的错误信息，包括：
- 错误类型
- 错误消息
- 堆栈跟踪
- 发生错误的文件位置

### 方法 2: 查看浏览器 Network 标签

1. 打开浏览器开发者工具
2. 切换到 **Network** 标签
3. 刷新页面
4. 点击失败的请求（通常是红色）
5. 查看 **Response** 标签中的错误信息

### 方法 3: 添加错误日志

在服务器端代码中添加日志：

```typescript
// 在 server/api/ 文件中
console.error('Error details:', error)
```

## 🚀 快速修复命令

```bash
# 1. 停止服务器（Ctrl + C）

# 2. 清理缓存
rm -rf .nuxt node_modules/.vite

# 3. 检查环境变量
cat .env

# 4. 重新启动
npm run dev
```

## 📞 如果问题仍然存在

请提供以下信息：
1. 终端中的完整错误信息
2. 浏览器控制台中的错误信息
3. `.env` 文件内容（隐藏敏感信息）
4. 访问的具体 URL

---

**提示**: 大多数 500 错误都是由于配置问题（数据库连接、环境变量）或代码错误导致的。仔细查看终端输出通常能找到问题所在。

