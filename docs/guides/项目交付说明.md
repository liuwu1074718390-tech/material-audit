# 材价审计系统 - 项目交付说明

## 📦 项目概述

本项目是一个基于 **Nuxt 3 + Vue 3 + Element Plus** 技术栈开发的智能材价审计管理系统。系统支持上传Excel格式的材料清单，通过集成Dify AI工作流进行智能价格分析，并提供完整的审计结果展示、筛选和导出功能。

## ✅ 已完成功能

### 1. 文件上传与解析
- ✅ 支持拖拽上传Excel文件（.xls/.xlsx格式）
- ✅ 自动解析Excel内容，提取9个字段的材料数据
- ✅ 实时显示解析状态和错误提示
- ✅ 自动提取C列类别数据并去重

### 2. 多步骤审计流程
- ✅ 第一步：文件上传界面，支持拖拽和点击上传
- ✅ 第二步：参数配置界面，包含三个筛选字段
  - 地区选择（省市级联选择，选填）
  - 时间范围选择（月份范围，选填）
  - 类别多选（从Excel自动提取，支持多选，选填）

### 3. Dify工作流集成
- ✅ 调用Dify API进行智能审计
- ✅ 传递材料数据和筛选参数
- ✅ 处理Dify返回结果并合并原始数据
- ✅ 开发模式下提供模拟数据支持（便于测试）

### 4. 审计结果展示
- ✅ 完整的结果列表，包含12个字段：
  - 序号、编码、类别、名称、规格型号、单位、数量
  - 不含税市场价、税率、不含税市场价合计
  - 推荐价格范围(不含税)、价格偏差
- ✅ 价格偏差颜色标识：
  - 🔴 红色：偏差 > +20%（价格偏高）
  - 🟢 绿色：偏差在 -20% ~ +20%（价格正常）
  - 🟡 黄色：偏差 < -20%（价格偏低）

### 5. 高级筛选功能
- ✅ 按编码筛选（文本输入）
- ✅ 按类别筛选（下拉选择）
- ✅ 按名称筛选（文本输入）
- ✅ 按规格型号筛选（文本输入）
- ✅ 按价格偏差范围筛选（三档：偏高/正常/偏低）
- ✅ 支持组合筛选
- ✅ 一键重置筛选条件

### 6. 数据导出
- ✅ 一键导出为Excel文件
- ✅ 支持导出筛选后的数据
- ✅ 包含所有12个审计字段
- ✅ 自动生成带时间戳的文件名

### 7. 数据持久化
- ✅ 预留数据库接口（server/utils/database.ts）
- ✅ 支持查询历史审计记录
- ✅ 内存存储实现（开发/测试用）
- ✅ 腾讯云数据库集成接口预留

## 📁 项目结构

```
材价审计/
├── app.vue                      # 应用根组件
├── nuxt.config.ts              # Nuxt配置
├── package.json                # 依赖配置
├── tsconfig.json               # TypeScript配置
├── .env.example                # 环境变量示例
├── .gitignore                  # Git忽略规则
├── Dockerfile                  # Docker镜像配置
├── docker-compose.yml          # Docker编排
├── LICENSE                     # MIT许可证
│
├── assets/                     # 静态资源
│   └── styles/
│       └── main.scss          # 全局样式
│
├── components/                 # Vue组件
│   ├── UploadDialog.vue       # 上传弹窗（多步骤）
│   └── AuditResultTable.vue   # 结果表格（筛选+导出）
│
├── composables/                # 组合式函数
│   ├── useExcelParser.ts      # Excel解析工具
│   └── useDifyApi.ts          # Dify API封装
│
├── pages/                      # 页面
│   └── index.vue              # 首页
│
├── server/                     # 服务端
│   ├── api/
│   │   ├── dify/
│   │   │   └── audit.post.ts  # Dify审计接口
│   │   └── audit-records.get.ts # 记录查询接口
│   └── utils/
│       └── database.ts        # 数据库工具类
│
├── types/                      # TypeScript类型
│   └── index.ts               # 全局类型定义
│
├── docs/                       # 完整文档
│   ├── USAGE.md               # 使用说明
│   ├── API.md                 # API文档
│   ├── DEPLOYMENT.md          # 部署指南
│   └── DIFY_INTEGRATION.md    # Dify集成指南
│
├── scripts/                    # 脚本工具
│   ├── setup.sh               # 自动安装脚本
│   └── start.sh               # 快速启动脚本
│
├── 上传材料/                   # 示例文件
│   └── 华工二期2025-10-12V2（控制价终稿）备案-人材机汇总.xls
│
└── 文档文件
    ├── README.md              # 项目说明
    ├── QUICKSTART.md          # 快速开始
    ├── INSTALL.md             # 安装说明
    ├── PROJECT_STRUCTURE.md   # 项目结构
    ├── CHANGELOG.md           # 更新日志
    └── 项目交付说明.md         # 本文件
```

## 🔧 技术栈

### 前端技术
- **Nuxt 3** (v3.10.0) - Vue.js的SSR框架
- **Vue 3** (v3.4.15) - 渐进式JavaScript框架
- **Element Plus** (v2.5.3) - Vue 3 UI组件库
- **TypeScript** - 类型安全
- **SCSS** - CSS预处理器
- **XLSX** (v0.18.5) - Excel文件处理

### 后端技术
- **Nitro** - Nuxt的服务器引擎
- **Node.js** (>=18) - JavaScript运行时

### 外部服务
- **Dify** - AI工作流平台
- **腾讯云** - 云服务（可选）

## 📖 文档清单

| 文档 | 说明 | 路径 |
|------|------|------|
| README.md | 项目总览和快速入门 | 根目录 |
| QUICKSTART.md | 5分钟快速开始指南 | 根目录 |
| INSTALL.md | 详细安装说明 | 根目录 |
| PROJECT_STRUCTURE.md | 项目结构详解 | 根目录 |
| CHANGELOG.md | 版本更新日志 | 根目录 |
| USAGE.md | 详细使用教程 | docs/ |
| API.md | 后端API接口文档 | docs/ |
| DEPLOYMENT.md | 生产环境部署指南 | docs/ |
| DIFY_INTEGRATION.md | Dify工作流集成指南 | docs/ |
| 项目交付说明.md | 项目交付文档（本文件） | 根目录 |

## 🚀 快速启动

### 方式一：自动安装（推荐）

```bash
cd /Users/liuwu/Desktop/材价审计
./scripts/setup.sh
```

### 方式二：手动启动

```bash
# 1. 安装依赖
npm install

# 2. 配置环境变量
cp .env.example .env
# 编辑.env文件，填入Dify API配置

# 3. 启动开发服务器
npm run dev

# 4. 访问系统
# 打开浏览器访问 http://localhost:3000
```

## ⚙️ 环境配置

### 必需配置（Dify API）

在 `.env` 文件中配置：

```env
DIFY_API_KEY=app-xxxxxxxxxxxxxxxxxxxxxxxx
DIFY_API_URL=https://api.dify.ai/v1/workflows/{workflow_id}/run
```

### 可选配置（腾讯云）

```env
TENCENT_SECRET_ID=your_secret_id
TENCENT_SECRET_KEY=your_secret_key
TENCENT_REGION=ap-guangzhou
```

## 🔌 Dify工作流配置

### 输入变量

| 变量名 | 类型 | 说明 | 必填 |
|--------|------|------|------|
| materials | Text | 材料数据JSON字符串 | 是 |
| region | Text | 地区信息 | 否 |
| timeRange | Text | 时间范围 | 否 |
| categories | Text | 选择的类别（逗号分隔） | 否 |

### 输出格式

```json
{
  "results": [
    {
      "序号": 1,
      "编码": "010101001001",
      "推荐价格范围": "3800 - 4100",
      "价格偏差": "+5.26%"
    }
  ]
}
```

**详细说明**: 查看 `docs/DIFY_INTEGRATION.md`

## 📊 Excel文件格式

系统要求上传的Excel文件包含以下列（A-I列）：

| 列 | 字段名 | 类型 | 必填 | 说明 |
|----|--------|------|------|------|
| A | 序号 | 数字/文本 | 否 | 材料序号 |
| B | 编码 | 文本 | ✅ 是 | 材料编码（唯一标识） |
| C | 类别 | 文本 | 否 | 材料类别（用于筛选） |
| D | 名称 | 文本 | 否 | 材料名称 |
| E | 规格型号 | 文本 | 否 | 规格型号 |
| F | 单位 | 文本 | 否 | 计量单位 |
| G | 数量 | 数字 | 否 | 数量 |
| H | 不含税市场价 | 数字 | 否 | 单价（不含税） |
| I | 税率 | 数字 | 否 | 税率（%） |

**注意**：
- 第1行为表头，数据从第2行开始
- 编码字段（B列）必填，用于识别材料
- 项目包含示例文件：`上传材料/华工二期2025-10-12V2（控制价终稿）备案-人材机汇总.xls`

## 🎯 使用流程

1. **启动系统** → 访问 http://localhost:3000
2. **上传文件** → 点击"上传文件"按钮，选择Excel文件
3. **配置参数** → 选择地区、时间、类别（可选）
4. **发起审计** → 点击"发起材价审计"按钮
5. **查看结果** → 浏览审计结果，关注价格偏差
6. **筛选数据** → 使用多维度筛选器定位问题
7. **导出报告** → 点击"导出Excel"保存结果

## 🐳 Docker部署

### 使用Docker Compose（推荐）

```bash
# 1. 配置环境变量
cp .env.example .env
# 编辑.env文件

# 2. 启动服务
docker-compose up -d

# 3. 查看日志
docker-compose logs -f

# 4. 停止服务
docker-compose down
```

### 使用Docker

```bash
# 1. 构建镜像
docker build -t material-audit .

# 2. 运行容器
docker run -d \
  -p 3000:3000 \
  -e DIFY_API_KEY=your_key \
  -e DIFY_API_URL=your_url \
  --name material-audit \
  material-audit

# 3. 查看日志
docker logs -f material-audit
```

## 📦 生产部署

### 构建生产版本

```bash
# 1. 安装生产依赖
npm ci --only=production

# 2. 构建
npm run build

# 3. 启动（方式一：直接运行）
node .output/server/index.mjs

# 3. 启动（方式二：使用PM2）
npm install -g pm2
pm2 start .output/server/index.mjs --name material-audit
pm2 save
pm2 startup
```

**详细部署指南**: 查看 `docs/DEPLOYMENT.md`

## 🔮 扩展开发

### 集成数据库

项目已预留数据库接口，位于 `server/utils/database.ts`

#### 集成MySQL示例

```typescript
import mysql from 'mysql2/promise'

const pool = mysql.createPool({
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME
})

export class Database {
  static async saveAuditRecord(record: AuditResultData) {
    const [result] = await pool.execute(
      'INSERT INTO audit_records SET ?',
      [record]
    )
    return result
  }
}
```

#### 集成腾讯云数据库

参考 `server/utils/database.ts` 中的注释说明。

### 添加新功能

#### 添加新页面

在 `pages/` 目录创建新的 `.vue` 文件，Nuxt会自动生成路由。

#### 添加新组件

在 `components/` 目录创建新的 `.vue` 文件，可直接使用。

#### 添加新API

在 `server/api/` 目录创建新的 `.ts` 文件，文件名即路由路径。

## ⚠️ 注意事项

### 开发环境
- 当前使用内存存储，重启后数据会丢失
- Dify调用失败时会使用模拟数据
- 适合开发和测试UI功能

### 生产环境
- **必须**集成数据库进行数据持久化
- **必须**配置有效的Dify API
- **建议**使用HTTPS
- **建议**配置反向代理（Nginx）
- **建议**使用PM2或Docker管理进程

## 📝 待实现功能（可选）

以下功能已预留接口，可根据需要实现：

- [ ] 腾讯云数据库集成
- [ ] Redis缓存支持
- [ ] 用户认证和权限管理
- [ ] 审计报告生成（PDF）
- [ ] 批量文件上传
- [ ] 价格趋势图表
- [ ] 审计历史对比
- [ ] 移动端适配

## 🆘 常见问题

### 1. npm install失败
```bash
npm config set registry https://registry.npmmirror.com
npm install
```

### 2. 端口被占用
```bash
PORT=3001 npm run dev
```

### 3. Dify API调用失败
- 检查API密钥和URL配置
- 确认工作流已发布
- 开发模式会自动使用模拟数据

### 4. Excel解析失败
- 确认文件格式为.xls或.xlsx
- 检查列顺序是否正确
- 确保编码字段（B列）不为空

**更多问题**: 查看 `QUICKSTART.md` 或 `docs/USAGE.md`

## 📞 技术支持

### 文档资源
- 项目文档：查看 `docs/` 目录
- 快速开始：`QUICKSTART.md`
- 安装说明：`INSTALL.md`

### 外部资源
- Nuxt文档: https://nuxt.com/docs
- Vue文档: https://vuejs.org/
- Element Plus: https://element-plus.org/
- Dify文档: https://docs.dify.ai/

## ✅ 交付清单

- [x] 完整的源代码
- [x] 所有功能实现（文件上传、审计、筛选、导出）
- [x] 完善的文档（10个文档文件）
- [x] 示例Excel文件
- [x] 自动安装脚本
- [x] Docker配置
- [x] 环境变量示例
- [x] TypeScript类型定义
- [x] 代码注释

## 📄 许可证

MIT License - 详见 `LICENSE` 文件

---

## 🎉 项目总结

本项目已完成所有需求功能的开发：

✅ **核心功能**：文件上传、Excel解析、Dify集成、结果展示  
✅ **筛选功能**：5个维度的数据筛选  
✅ **导出功能**：Excel格式导出  
✅ **UI/UX**：现代化、响应式设计  
✅ **文档**：完整的使用和部署文档  
✅ **扩展性**：预留数据库和云服务接口  

项目采用 **Nuxt 3 + Vue 3** 技术栈，代码结构清晰，易于维护和扩展。

**开始使用**: 运行 `./scripts/setup.sh` 或查看 `QUICKSTART.md`

祝使用愉快！🚀

