# æä»·å®¡è®¡ç³»ç»Ÿ - æœåŠ¡å™¨éƒ¨ç½²è¯¦ç»†æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [å‰ç½®å‡†å¤‡](#å‰ç½®å‡†å¤‡)
2. [æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡](#æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡)
3. [ä»£ç éƒ¨ç½²](#ä»£ç éƒ¨ç½²)
4. [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
5. [æ„å»ºå’Œå¯åŠ¨](#æ„å»ºå’Œå¯åŠ¨)
6. [Nginx åå‘ä»£ç†é…ç½®](#nginx-åå‘ä»£ç†é…ç½®)
7. [PM2 è¿›ç¨‹ç®¡ç†](#pm2-è¿›ç¨‹ç®¡ç†)
8. [SSL/HTTPS é…ç½®](#sslhttps-é…ç½®)
9. [æ—¥å¸¸ç»´æŠ¤](#æ—¥å¸¸ç»´æŠ¤)
10. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## ğŸ“‹ å‰ç½®å‡†å¤‡

### 1. æœåŠ¡å™¨è¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04+ / CentOS 7+ / Debian 10+
- **CPU**: 2æ ¸æˆ–ä»¥ä¸Š
- **å†…å­˜**: 4GB æˆ–ä»¥ä¸Š
- **ç£ç›˜**: 20GB æˆ–ä»¥ä¸Š
- **ç½‘ç»œ**: å…¬ç½‘ IPï¼Œå¸¦å®½ 5Mbps æˆ–ä»¥ä¸Š

### 2. éœ€è¦å‡†å¤‡çš„ä¿¡æ¯

- âœ… æœåŠ¡å™¨ IP åœ°å€
- âœ… SSH ç™»å½•è´¦å·å’Œå¯†ç ï¼ˆæˆ–å¯†é’¥ï¼‰
- âœ… åŸŸåï¼ˆå¯é€‰ï¼Œå¦‚æœä½¿ç”¨åŸŸåè®¿é—®ï¼‰
- âœ… Dify API é…ç½®ä¿¡æ¯
- âœ… æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼ˆå¦‚æœä½¿ç”¨å¤–éƒ¨æ•°æ®åº“ï¼‰

### 3. éœ€è¦å¼€æ”¾çš„ç«¯å£

- **22** - SSH è¿œç¨‹è¿æ¥
- **80** - HTTPï¼ˆå¦‚æœä½¿ç”¨ Nginxï¼‰
- **443** - HTTPSï¼ˆå¦‚æœä½¿ç”¨ SSLï¼‰
- **3000** - åº”ç”¨ç«¯å£ï¼ˆå¦‚æœç›´æ¥è®¿é—®ï¼‰

---

## ğŸ–¥ï¸ æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

### æ­¥éª¤ 1: è¿æ¥æœåŠ¡å™¨

```bash
# ä½¿ç”¨ SSH è¿æ¥æœåŠ¡å™¨
ssh root@your-server-ip
# æˆ–ä½¿ç”¨å¯†é’¥
ssh -i ~/.ssh/your-key.pem root@your-server-ip
```

### æ­¥éª¤ 2: æ›´æ–°ç³»ç»Ÿ

#### Ubuntu/Debian

```bash
# æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
apt-get update

# å‡çº§ç³»ç»Ÿ
apt-get upgrade -y

# å®‰è£…åŸºç¡€å·¥å…·
apt-get install -y curl wget git vim nano
```

#### CentOS/RHEL

```bash
# æ›´æ–°ç³»ç»Ÿ
yum update -y

# å®‰è£…åŸºç¡€å·¥å…·
yum install -y curl wget git vim nano
```

### æ­¥éª¤ 3: å®‰è£… Node.js 20.19.0

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨ NodeSourceï¼ˆæ¨èï¼‰

```bash
# ä¸‹è½½å¹¶å®‰è£… Node.js 20.x
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -

# Ubuntu/Debian
apt-get install -y nodejs

# CentOS/RHEL
yum install -y nodejs

# éªŒè¯å®‰è£…
node -v  # åº”è¯¥æ˜¾ç¤º v20.19.0 æˆ–æ›´é«˜
npm -v   # åº”è¯¥æ˜¾ç¤º 9.0.0 æˆ–æ›´é«˜
```

#### æ–¹å¼äºŒï¼šä½¿ç”¨ NVMï¼ˆNode Version Managerï¼‰

```bash
# å®‰è£… NVM
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# é‡æ–°åŠ è½½ shell é…ç½®
source ~/.bashrc

# å®‰è£… Node.js 20.19.0
nvm install 20.19.0
nvm use 20.19.0
nvm alias default 20.19.0

# éªŒè¯
node -v
npm -v
```

### æ­¥éª¤ 4: å®‰è£… PM2ï¼ˆè¿›ç¨‹ç®¡ç†å™¨ï¼‰

```bash
# å…¨å±€å®‰è£… PM2
npm install -g pm2

# é…ç½® PM2 å¼€æœºè‡ªå¯
pm2 startup systemd -u root --hp /root

# éªŒè¯å®‰è£…
pm2 --version
```

### æ­¥éª¤ 5: å®‰è£… Nginxï¼ˆå¯é€‰ï¼Œæ¨èï¼‰

```bash
# Ubuntu/Debian
apt-get install -y nginx

# CentOS/RHEL
yum install -y nginx

# å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯
systemctl start nginx
systemctl enable nginx

# éªŒè¯å®‰è£…
nginx -v
```

### æ­¥éª¤ 6: é…ç½®é˜²ç«å¢™

#### Ubuntu/Debian (UFW)

```bash
# å¯ç”¨é˜²ç«å¢™
ufw enable

# å¼€æ”¾å¿…è¦ç«¯å£
ufw allow 22/tcp    # SSH
ufw allow 80/tcp    # HTTP
ufw allow 443/tcp   # HTTPS
ufw allow 3000/tcp  # åº”ç”¨ç«¯å£ï¼ˆå¦‚æœç›´æ¥è®¿é—®ï¼‰

# æŸ¥çœ‹çŠ¶æ€
ufw status
```

#### CentOS/RHEL (firewalld)

```bash
# å¯åŠ¨é˜²ç«å¢™
systemctl start firewalld
systemctl enable firewalld

# å¼€æ”¾ç«¯å£
firewall-cmd --permanent --add-port=22/tcp
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --permanent --add-port=3000/tcp

# é‡è½½é˜²ç«å¢™
firewall-cmd --reload

# æŸ¥çœ‹çŠ¶æ€
firewall-cmd --list-all
```

---

## ğŸ“¦ ä»£ç éƒ¨ç½²

### æ–¹å¼ä¸€ï¼šä» Git ä»“åº“å…‹éš†ï¼ˆæ¨èï¼‰

```bash
# åˆ›å»ºåº”ç”¨ç›®å½•
mkdir -p /opt/material-audit
cd /opt/material-audit

# å…‹éš†ä»£ç ï¼ˆæ›¿æ¢ä¸ºä½ çš„ä»“åº“åœ°å€ï¼‰
git clone https://github.com/liuwu1074718390-tech/material-audit.git .

# æˆ–å¦‚æœä»“åº“æ˜¯ç§æœ‰çš„ï¼Œä½¿ç”¨ SSH
# git clone git@github.com:liuwu1074718390-tech/material-audit.git .
```

### æ–¹å¼äºŒï¼šä»æœ¬åœ°ä¸Šä¼ 

#### åœ¨æœ¬åœ°ç”µè„‘æ“ä½œï¼š

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /Users/liuwu/Desktop/æä»·å®¡è®¡

# æ‰“åŒ…é¡¹ç›®ï¼ˆæ’é™¤ node_modules å’Œ .gitï¼‰
tar -czf material-audit.tar.gz \
  --exclude='node_modules' \
  --exclude='.git' \
  --exclude='.output' \
  --exclude='.nuxt' \
  --exclude='*.log' \
  .

# ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp material-audit.tar.gz root@your-server-ip:/opt/
```

#### åœ¨æœåŠ¡å™¨ä¸Šæ“ä½œï¼š

```bash
# åˆ›å»ºåº”ç”¨ç›®å½•
mkdir -p /opt/material-audit
cd /opt

# è§£å‹æ–‡ä»¶
tar -xzf material-audit.tar.gz -C material-audit

# è¿›å…¥ç›®å½•
cd /opt/material-audit
```

---

## âš™ï¸ ç¯å¢ƒé…ç½®

### æ­¥éª¤ 1: åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶

```bash
cd /opt/material-audit

# åˆ›å»º .env æ–‡ä»¶
nano .env
```

### æ­¥éª¤ 2: é…ç½®ç¯å¢ƒå˜é‡

å°†ä»¥ä¸‹å†…å®¹å¤åˆ¶åˆ° `.env` æ–‡ä»¶ä¸­ï¼Œå¹¶æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼š

```env
# ==========================================
# Dify API é…ç½®ï¼ˆå¿…éœ€ï¼‰
# ==========================================
DIFY_API_KEY=app-CaJJxI5P0DrvwNXAhABB37M6
DIFY_API_URL=http://192.168.1.42/v1/workflows/run
DIFY_WORKFLOW_ID=6495412f-cb02-4702-a1e4-5471a37919c7

# ==========================================
# æ•°æ®åº“é…ç½®ï¼ˆå¿…éœ€ï¼‰
# ==========================================
DB_HOST=gz-cdb-gaxrunxl.sql.tencentcdb.com
DB_PORT=28544
DB_USER=root
DB_PASSWORD=Lw05044918
DB_NAME=myapp

# ==========================================
# åº”ç”¨é…ç½®
# ==========================================
NODE_ENV=production
PORT=3000
NUXT_PUBLIC_API_BASE=/api

# ==========================================
# è…¾è®¯äº‘é…ç½®ï¼ˆå¯é€‰ï¼‰
# ==========================================
TENCENT_SECRET_ID=your-tencent-secret-id
TENCENT_SECRET_KEY=your-tencent-secret-key
TENCENT_REGION=ap-guangzhou

# ==========================================
# COS é…ç½®ï¼ˆå¯é€‰ï¼‰
# ==========================================
COS_BUCKET=my-audit-bucket-1256824609
COS_REGION=ap-guangzhou
COS_BASE_URL=https://my-audit-bucket-1256824609.cos.ap-guangzhou.myqcloud.com
```

**é‡è¦æç¤º**ï¼š
- âš ï¸ `DIFY_API_URL` å¦‚æœæ˜¯å†…ç½‘åœ°å€ï¼ˆå¦‚ `http://192.168.1.42`ï¼‰ï¼Œç¡®ä¿æœåŠ¡å™¨å¯ä»¥è®¿é—®è¯¥å†…ç½‘
- âš ï¸ å¦‚æœæœåŠ¡å™¨æ— æ³•è®¿é—®å†…ç½‘ï¼Œéœ€è¦é…ç½®å†…ç½‘ç©¿é€æˆ–ä½¿ç”¨å…¬ç½‘åœ°å€
- ğŸ”’ ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æ›´å®‰å…¨çš„å¯†ç å’Œå¯†é’¥

### æ­¥éª¤ 3: è®¾ç½®æ–‡ä»¶æƒé™

```bash
# è®¾ç½® .env æ–‡ä»¶æƒé™ï¼ˆä»…æ‰€æœ‰è€…å¯è¯»å†™ï¼‰
chmod 600 .env

# ç¡®ä¿ç›®å½•æƒé™æ­£ç¡®
chown -R root:root /opt/material-audit
```

---

## ğŸ”¨ æ„å»ºå’Œå¯åŠ¨

### æ­¥éª¤ 1: å®‰è£…ä¾èµ–

```bash
cd /opt/material-audit

# å®‰è£…ä¾èµ–ï¼ˆä½¿ç”¨ --legacy-peer-deps é¿å…ä¾èµ–å†²çªï¼‰
npm install --legacy-peer-deps

# å¦‚æœå®‰è£…å¤±è´¥ï¼Œå¯ä»¥å°è¯•æ¸…é™¤ç¼“å­˜
npm cache clean --force
npm install --legacy-peer-deps
```

### æ­¥éª¤ 2: æ„å»ºé¡¹ç›®

```bash
# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# æ„å»ºå®Œæˆåï¼Œæ£€æŸ¥è¾“å‡ºç›®å½•
ls -la .output/public
ls -la .output/server
```

**é¢„æœŸè¾“å‡º**ï¼š
- `.output/public/` - é™æ€æ–‡ä»¶ç›®å½•
- `.output/server/` - æœåŠ¡å™¨ç«¯æ–‡ä»¶ç›®å½•

### æ­¥éª¤ 3: åˆ›å»º PM2 é…ç½®æ–‡ä»¶

```bash
cd /opt/material-audit

# åˆ›å»º PM2 é…ç½®æ–‡ä»¶
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'material-audit',
    script: '.output/server/index.mjs',
    cwd: '/opt/material-audit',
    instances: 1,
    exec_mode: 'fork',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    env_file: '.env',
    error_file: '/opt/material-audit/logs/pm2-error.log',
    out_file: '/opt/material-audit/logs/pm2-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    autorestart: true,
    max_memory_restart: '500M',
    min_uptime: '10s',
    max_restarts: 10
  }]
}
EOF

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs
```

### æ­¥éª¤ 4: å¯åŠ¨åº”ç”¨

```bash
# ä½¿ç”¨ PM2 å¯åŠ¨åº”ç”¨
pm2 start ecosystem.config.js

# ä¿å­˜ PM2 é…ç½®ï¼ˆå¼€æœºè‡ªå¯ï¼‰
pm2 save

# æŸ¥çœ‹åº”ç”¨çŠ¶æ€
pm2 status

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
pm2 logs material-audit
```

### æ­¥éª¤ 5: éªŒè¯åº”ç”¨è¿è¡Œ

```bash
# æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
netstat -tlnp | grep 3000
# æˆ–
ss -tlnp | grep 3000

# æµ‹è¯•æœ¬åœ°è®¿é—®
curl http://localhost:3000

# æŸ¥çœ‹ PM2 è¯¦ç»†ä¿¡æ¯
pm2 info material-audit
```

---

## ğŸŒ Nginx åå‘ä»£ç†é…ç½®

### æ­¥éª¤ 1: åˆ›å»º Nginx é…ç½®æ–‡ä»¶

```bash
# åˆ›å»ºé…ç½®æ–‡ä»¶
cat > /etc/nginx/sites-available/material-audit << 'EOF'
server {
    listen 80;
    server_name your-domain.com;  # æ›¿æ¢ä¸ºä½ çš„åŸŸåæˆ– IP

    # æ—¥å¿—é…ç½®
    access_log /var/log/nginx/material-audit-access.log;
    error_log /var/log/nginx/material-audit-error.log;

    # å®¢æˆ·ç«¯æœ€å¤§ä¸Šä¼ æ–‡ä»¶å¤§å°ï¼ˆæ ¹æ®éœ€æ±‚è°ƒæ•´ï¼‰
    client_max_body_size 50M;

    # è¶…æ—¶è®¾ç½®
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    send_timeout 300s;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        
        # WebSocket æ”¯æŒ
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        
        # è¯·æ±‚å¤´è®¾ç½®
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # ç¼“å­˜æ§åˆ¶
        proxy_cache_bypass $http_upgrade;
        
        # ç¼“å†²è®¾ç½®
        proxy_buffering off;
    }

    # é™æ€èµ„æºç¼“å­˜
    location /_nuxt/ {
        proxy_pass http://localhost:3000;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location /assets/ {
        proxy_pass http://localhost:3000;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
EOF
```

**æ³¨æ„**ï¼šå°† `your-domain.com` æ›¿æ¢ä¸ºä½ çš„å®é™…åŸŸåæˆ– IP åœ°å€ã€‚

### æ­¥éª¤ 2: å¯ç”¨ç«™ç‚¹

```bash
# åˆ›å»ºç¬¦å·é“¾æ¥ï¼ˆUbuntu/Debianï¼‰
ln -s /etc/nginx/sites-available/material-audit /etc/nginx/sites-enabled/

# CentOS/RHEL ç›´æ¥ä½¿ç”¨
# cp /etc/nginx/sites-available/material-audit /etc/nginx/conf.d/material-audit.conf

# æµ‹è¯•é…ç½®
nginx -t

# å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œé‡å¯ Nginx
systemctl restart nginx
```

### æ­¥éª¤ 3: éªŒè¯ Nginx é…ç½®

```bash
# æ£€æŸ¥ Nginx çŠ¶æ€
systemctl status nginx

# æµ‹è¯•è®¿é—®
curl http://your-domain.com
# æˆ–
curl http://your-server-ip
```

---

## ğŸ”„ PM2 è¿›ç¨‹ç®¡ç†

### å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹æ‰€æœ‰åº”ç”¨çŠ¶æ€
pm2 status

# æŸ¥çœ‹åº”ç”¨è¯¦ç»†ä¿¡æ¯
pm2 info material-audit

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
pm2 logs material-audit

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œæ—¥å¿—
pm2 logs material-audit --lines 100

# åªæŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs material-audit --err

# é‡å¯åº”ç”¨
pm2 restart material-audit

# åœæ­¢åº”ç”¨
pm2 stop material-audit

# å¯åŠ¨åº”ç”¨
pm2 start material-audit

# åˆ é™¤åº”ç”¨ï¼ˆä» PM2 åˆ—è¡¨ä¸­ç§»é™¤ï¼‰
pm2 delete material-audit

# ç›‘æ§åº”ç”¨
pm2 monit

# æŸ¥çœ‹åº”ç”¨èµ„æºä½¿ç”¨æƒ…å†µ
pm2 show material-audit
```

### è‡ªåŠ¨é‡å¯é…ç½®

PM2 å·²é…ç½®è‡ªåŠ¨é‡å¯ï¼Œå¦‚æœåº”ç”¨å´©æºƒä¼šè‡ªåŠ¨é‡å¯ã€‚ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨é…ç½®ï¼š

```bash
# è®¾ç½®åº”ç”¨åœ¨ç³»ç»Ÿé‡å¯åè‡ªåŠ¨å¯åŠ¨
pm2 startup

# ä¿å­˜å½“å‰ PM2 è¿›ç¨‹åˆ—è¡¨
pm2 save
```

---

## ğŸ”’ SSL/HTTPS é…ç½®

### ä½¿ç”¨ Let's Encrypt å…è´¹ SSL è¯ä¹¦

#### æ­¥éª¤ 1: å®‰è£… Certbot

```bash
# Ubuntu/Debian
apt-get install -y certbot python3-certbot-nginx

# CentOS/RHEL
yum install -y certbot python3-certbot-nginx
```

#### æ­¥éª¤ 2: è·å– SSL è¯ä¹¦

```bash
# è·å–è¯ä¹¦ï¼ˆæ›¿æ¢ä¸ºä½ çš„åŸŸåï¼‰
certbot --nginx -d your-domain.com

# å¦‚æœæœ‰å¤šä¸ªåŸŸå
certbot --nginx -d your-domain.com -d www.your-domain.com
```

Certbot ä¼šè‡ªåŠ¨ï¼š
- è·å– SSL è¯ä¹¦
- é…ç½® Nginx
- è®¾ç½®è‡ªåŠ¨ç»­æœŸ

#### æ­¥éª¤ 3: æµ‹è¯•è‡ªåŠ¨ç»­æœŸ

```bash
# æµ‹è¯•ç»­æœŸï¼ˆä¸ä¼šçœŸæ­£ç»­æœŸï¼‰
certbot renew --dry-run

# æ‰‹åŠ¨ç»­æœŸ
certbot renew
```

#### æ­¥éª¤ 4: é…ç½®è‡ªåŠ¨ç»­æœŸ

```bash
# ç¼–è¾‘ crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯å¤©å‡Œæ™¨ 2 ç‚¹æ£€æŸ¥ç»­æœŸï¼‰
0 2 * * * certbot renew --quiet
```

---

## ğŸ”„ æ—¥å¸¸ç»´æŠ¤

### æ›´æ–°åº”ç”¨ä»£ç 

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨æ›´æ–°è„šæœ¬

```bash
cd /opt/material-audit
bash scripts/update.sh
```

#### æ–¹å¼äºŒï¼šæ‰‹åŠ¨æ›´æ–°

```bash
cd /opt/material-audit

# 1. å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰
cp -r .output .output.backup

# 2. æ‹‰å–æœ€æ–°ä»£ç 
git pull

# 3. å®‰è£…æ–°ä¾èµ–
npm install --legacy-peer-deps

# 4. é‡æ–°æ„å»º
npm run build

# 5. é‡å¯åº”ç”¨
pm2 restart material-audit

# 6. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤å¯åŠ¨æˆåŠŸ
pm2 logs material-audit --lines 50
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# PM2 æ—¥å¿—
pm2 logs material-audit

# åº”ç”¨æ—¥å¿—æ–‡ä»¶
tail -f /opt/material-audit/logs/pm2-out.log
tail -f /opt/material-audit/logs/pm2-error.log

# Nginx è®¿é—®æ—¥å¿—
tail -f /var/log/nginx/material-audit-access.log

# Nginx é”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/material-audit-error.log

# ç³»ç»Ÿæ—¥å¿—
journalctl -u nginx -f
```

### å¤‡ä»½æ•°æ®

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p /opt/backups

# å¤‡ä»½åº”ç”¨ä»£ç å’Œé…ç½®
tar -czf /opt/backups/material-audit-$(date +%Y%m%d-%H%M%S).tar.gz \
  /opt/material-audit \
  --exclude='node_modules' \
  --exclude='.output' \
  --exclude='.nuxt'

# å¤‡ä»½æ•°æ®åº“ï¼ˆå¦‚æœä½¿ç”¨æœ¬åœ°æ•°æ®åº“ï¼‰
# mysqldump -u root -p myapp > /opt/backups/db-$(date +%Y%m%d-%H%M%S).sql
```

### ç›‘æ§æœåŠ¡å™¨èµ„æº

```bash
# å®‰è£…ç›‘æ§å·¥å…·
apt-get install -y htop

# æŸ¥çœ‹ CPU å’Œå†…å­˜ä½¿ç”¨
htop

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æŸ¥çœ‹ PM2 èµ„æºä½¿ç”¨
pm2 monit
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: åº”ç”¨æ— æ³•å¯åŠ¨

**æ£€æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æŸ¥çœ‹ PM2 æ—¥å¿—
pm2 logs material-audit --err

# 2. æ£€æŸ¥ç¯å¢ƒå˜é‡
pm2 env material-audit

# 3. æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
cd /opt/material-audit
node .output/server/index.mjs

# 4. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -tlnp | grep 3000
lsof -i :3000

# 5. æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la .output/server/index.mjs
```

**å¸¸è§åŸå› **ï¼š
- ç¯å¢ƒå˜é‡æœªé…ç½®æˆ–é…ç½®é”™è¯¯
- ç«¯å£è¢«å ç”¨
- æ„å»ºå¤±è´¥ï¼Œ`.output` ç›®å½•ä¸å­˜åœ¨
- æ–‡ä»¶æƒé™é—®é¢˜

### é—®é¢˜ 2: 502 Bad Gateway

**æ£€æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æ£€æŸ¥åº”ç”¨æ˜¯å¦è¿è¡Œ
pm2 status

# 2. æ£€æŸ¥åº”ç”¨ç«¯å£
netstat -tlnp | grep 3000

# 3. æ£€æŸ¥ Nginx é…ç½®
nginx -t

# 4. æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/material-audit-error.log

# 5. æµ‹è¯•åº”ç”¨æ˜¯å¦å“åº”
curl http://localhost:3000
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å¦‚æœåº”ç”¨æœªè¿è¡Œï¼š`pm2 start material-audit`
- å¦‚æœç«¯å£ä¸å¯¹ï¼šæ£€æŸ¥ Nginx é…ç½®ä¸­çš„ `proxy_pass` åœ°å€
- å¦‚æœåº”ç”¨å´©æºƒï¼šæŸ¥çœ‹ PM2 æ—¥å¿—æ‰¾å‡ºåŸå› 

### é—®é¢˜ 3: æ•°æ®åº“è¿æ¥å¤±è´¥

**æ£€æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æ£€æŸ¥ç¯å¢ƒå˜é‡
cat /opt/material-audit/.env | grep DB_

# 2. æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -h gz-cdb-gaxrunxl.sql.tencentcdb.com -P 28544 -u root -p

# 3. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
# ç¡®ä¿æ•°æ®åº“æœåŠ¡å™¨å…è®¸ä½ çš„æœåŠ¡å™¨ IP è®¿é—®

# 4. æŸ¥çœ‹åº”ç”¨æ—¥å¿—
pm2 logs material-audit | grep -i database
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æ•°æ®åº“åœ°å€ã€ç«¯å£ã€ç”¨æˆ·åã€å¯†ç æ˜¯å¦æ­£ç¡®
- ç¡®ä¿æ•°æ®åº“æœåŠ¡å™¨å…è®¸å¤–éƒ¨ IP è®¿é—®
- æ£€æŸ¥æ•°æ®åº“å®‰å…¨ç»„è§„åˆ™

### é—®é¢˜ 4: Dify API è°ƒç”¨å¤±è´¥

**æ£€æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æ£€æŸ¥ç¯å¢ƒå˜é‡
cat /opt/material-audit/.env | grep DIFY_

# 2. æµ‹è¯• API è¿æ¥
curl -X POST http://192.168.1.42/v1/workflows/run \
  -H "Authorization: Bearer app-CaJJxI5P0DrvwNXAhABB37M6" \
  -H "Content-Type: application/json"

# 3. æŸ¥çœ‹åº”ç”¨æ—¥å¿—
pm2 logs material-audit | grep -i dify
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å¦‚æœ `DIFY_API_URL` æ˜¯å†…ç½‘åœ°å€ï¼Œç¡®ä¿æœåŠ¡å™¨å¯ä»¥è®¿é—®è¯¥å†…ç½‘
- æ£€æŸ¥ API å¯†é’¥æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ Dify æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ

### é—®é¢˜ 5: å†…å­˜ä¸è¶³

**æ£€æŸ¥æ­¥éª¤**ï¼š

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æŸ¥çœ‹ PM2 å†…å­˜ä½¿ç”¨
pm2 monit

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
htop
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- PM2 å·²é…ç½® `max_memory_restart: '500M'`ï¼Œè¶…è¿‡é™åˆ¶ä¼šè‡ªåŠ¨é‡å¯
- å¦‚æœå†…å­˜ä¸è¶³ï¼Œè€ƒè™‘å‡çº§æœåŠ¡å™¨é…ç½®
- å¯ä»¥è°ƒæ•´ PM2 çš„å†…å­˜é™åˆ¶

### é—®é¢˜ 6: æ„å»ºå¤±è´¥

**æ£€æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æ£€æŸ¥ Node.js ç‰ˆæœ¬
node -v  # åº”è¯¥æ˜¯ 20.19.0 æˆ–æ›´é«˜

# 2. æ¸…é™¤ç¼“å­˜é‡æ–°å®‰è£…
cd /opt/material-audit
rm -rf node_modules package-lock.json
npm cache clean --force
npm install --legacy-peer-deps

# 3. é‡æ–°æ„å»º
npm run build

# 4. æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
npm run build 2>&1 | tee build.log
```

---

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

éƒ¨ç½²å®Œæˆåï¼Œè¯·é€ä¸€æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] Node.js 20.19.0+ å·²å®‰è£…
- [ ] npm 9.0.0+ å·²å®‰è£…
- [ ] PM2 å·²å®‰è£…å¹¶é…ç½®å¼€æœºè‡ªå¯
- [ ] Nginx å·²å®‰è£…å¹¶è¿è¡Œï¼ˆå¦‚ä½¿ç”¨ï¼‰
- [ ] ä»£ç å·²éƒ¨ç½²åˆ° `/opt/material-audit`
- [ ] `.env` æ–‡ä»¶å·²åˆ›å»ºå¹¶é…ç½®
- [ ] ä¾èµ–å·²å®‰è£…ï¼ˆ`node_modules` å­˜åœ¨ï¼‰
- [ ] é¡¹ç›®å·²æ„å»ºæˆåŠŸï¼ˆ`.output` ç›®å½•å­˜åœ¨ï¼‰
- [ ] PM2 åº”ç”¨å·²å¯åŠ¨ï¼ˆ`pm2 status` æ˜¾ç¤º runningï¼‰
- [ ] ç«¯å£ 3000 æ­£åœ¨ç›‘å¬
- [ ] å¯ä»¥é€šè¿‡ `http://localhost:3000` è®¿é—®
- [ ] Nginx é…ç½®æ­£ç¡®ï¼ˆå¦‚ä½¿ç”¨ï¼‰
- [ ] å¯ä»¥é€šè¿‡åŸŸåæˆ– IP è®¿é—®ï¼ˆå¦‚ä½¿ç”¨ Nginxï¼‰
- [ ] é˜²ç«å¢™ç«¯å£å·²å¼€æ”¾
- [ ] SSL è¯ä¹¦å·²é…ç½®ï¼ˆå¦‚ä½¿ç”¨ HTTPSï¼‰
- [ ] æ—¥å¿—ç›®å½•å·²åˆ›å»º
- [ ] å¤‡ä»½è„šæœ¬å·²é…ç½®ï¼ˆå¯é€‰ï¼‰

---

## ğŸ” å®‰å…¨å»ºè®®

### 1. ä¿®æ”¹ SSH ç«¯å£ï¼ˆå¯é€‰ï¼‰

```bash
# ç¼–è¾‘ SSH é…ç½®
nano /etc/ssh/sshd_config

# ä¿®æ”¹ Port 22 ä¸ºå…¶ä»–ç«¯å£ï¼ˆå¦‚ 2222ï¼‰
Port 2222

# é‡å¯ SSH æœåŠ¡
systemctl restart sshd

# æ›´æ–°é˜²ç«å¢™è§„åˆ™
ufw allow 2222/tcp
```

### 2. ç¦ç”¨ root ç™»å½•ï¼ˆå¯é€‰ï¼‰

```bash
# åˆ›å»ºæ–°ç”¨æˆ·
adduser deploy
usermod -aG sudo deploy

# é…ç½® SSH å¯†é’¥ç™»å½•
# ç„¶åç¼–è¾‘ /etc/ssh/sshd_config
# PermitRootLogin no

# é‡å¯ SSH
systemctl restart sshd
```

### 3. å®šæœŸæ›´æ–°ç³»ç»Ÿ

```bash
# è®¾ç½®è‡ªåŠ¨æ›´æ–°ï¼ˆUbuntuï¼‰
apt-get install -y unattended-upgrades
dpkg-reconfigure -plow unattended-upgrades

# æˆ–æ‰‹åŠ¨æ›´æ–°
apt-get update && apt-get upgrade -y
```

### 4. é…ç½®é˜²ç«å¢™è§„åˆ™

åªå¼€æ”¾å¿…è¦çš„ç«¯å£ï¼Œé™åˆ¶ä¸å¿…è¦çš„è®¿é—®ã€‚

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**ï¼š
   ```bash
   pm2 logs material-audit
   tail -f /var/log/nginx/material-audit-error.log
   ```

2. **æ£€æŸ¥æœåŠ¡çŠ¶æ€**ï¼š
   ```bash
   pm2 status
   systemctl status nginx
   ```

3. **æŸ¥çœ‹ç³»ç»Ÿèµ„æº**ï¼š
   ```bash
   htop
   df -h
   free -h
   ```

4. **æµ‹è¯•ç½‘ç»œè¿æ¥**ï¼š
   ```bash
   curl http://localhost:3000
   ping your-domain.com
   ```

---

## âœ… éƒ¨ç½²å®Œæˆ

éƒ¨ç½²å®Œæˆåï¼Œä½ çš„ç³»ç»Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®ï¼š

- **ç›´æ¥è®¿é—®**: `http://your-server-ip:3000`
- **é€šè¿‡ Nginx**: `http://your-domain.com` æˆ– `http://your-server-ip`
- **HTTPS**: `https://your-domain.com`ï¼ˆå¦‚æœé…ç½®äº† SSLï¼‰

**æ­å–œï¼éƒ¨ç½²å®Œæˆï¼** ğŸ‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¿«é€Ÿå¼€å§‹æŒ‡å—](QUICKSTART.md)
- [ä½¿ç”¨è¯´æ˜](docs/USAGE.md)
- [API æ–‡æ¡£](docs/API.md)
- [Dify é›†æˆ](docs/DIFY_INTEGRATION.md)

