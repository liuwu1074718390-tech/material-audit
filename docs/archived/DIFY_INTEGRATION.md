# Dify工作流集成指南

## 概述

本文档详细说明如何配置和集成Dify工作流，用于材料价格审计分析。

## Dify工作流设计

### 工作流输入节点

创建一个工作流，配置以下输入变量：

| 变量名 | 类型 | 描述 | 必填 |
|--------|------|------|------|
| materials | Text | 材料数据JSON字符串 | 是 |
| region | Text | 地区信息 | 否 |
| timeRange | Text | 时间范围 | 否 |
| categories | Text | 选择的类别（逗号分隔） | 否 |

### 工作流处理逻辑建议

#### 1. 数据预处理节点

```
输入：materials (JSON字符串)
处理：
  - 解析JSON数据
  - 验证数据完整性
  - 提取关键字段（编码、名称、规格、价格等）
输出：结构化的材料列表
```

#### 2. 地区价格查询节点

```
输入：材料信息 + region
处理：
  - 根据地区查询当地建材市场价格
  - 获取历史价格趋势
  - 考虑地区差异因素
输出：地区参考价格
```

#### 3. 时间价格分析节点

```
输入：材料信息 + timeRange
处理：
  - 分析指定时间段的价格波动
  - 识别价格趋势（上涨/下跌/稳定）
  - 计算平均价格
输出：时间段价格分析结果
```

#### 4. 价格对比分析节点

```
输入：上传价格 + 市场价格
处理：
  - 对比上传价格与市场价格
  - 计算价格偏差百分比
  - 判断价格合理性
输出：价格偏差分析
```

#### 5. 推荐价格生成节点

```
输入：市场价格数据 + 分析结果
处理：
  - 综合考虑地区、时间、类别因素
  - 生成合理的价格区间
  - 考虑市场波动和采购风险
输出：推荐价格范围
```

#### 6. 结果汇总节点

```
输入：所有分析结果
处理：
  - 汇总每个材料的分析结果
  - 格式化输出数据
  - 生成审计报告
输出：最终审计结果JSON
```

### 工作流输出格式

工作流应返回以下JSON格式：

```json
{
  "results": [
    {
      "序号": 1,
      "编码": "010101001001",
      "推荐价格范围": "3800 - 4100",
      "价格偏差": "+5.26%"
    },
    {
      "序号": 2,
      "编码": "010201002001",
      "推荐价格范围": "350 - 410",
      "价格偏差": "-7.14%"
    }
  ]
}
```

## Dify API配置

### 1. 获取API密钥

1. 登录 [Dify平台](https://dify.ai)
2. 进入"工作区设置" > "API密钥"
3. 创建新的API密钥并复制

### 2. 获取工作流ID

1. 打开你创建的工作流
2. 点击"发布"按钮
3. 在API访问页面找到工作流ID
4. API URL格式：`https://api.dify.ai/v1/workflows/{workflow_id}/run`

### 3. 配置环境变量

在项目根目录的 `.env` 文件中配置：

```env
DIFY_API_KEY=app-xxxxxxxxxxxxxxxxxxxxx
DIFY_API_URL=https://api.dify.ai/v1/workflows/{workflow_id}/run
```

## API调用示例

### 请求示例

```bash
curl -X POST 'https://api.dify.ai/v1/workflows/{workflow_id}/run' \
  -H 'Authorization: Bearer YOUR_API_KEY' \
  -H 'Content-Type: application/json' \
  -d '{
    "inputs": {
      "materials": "[{\"序号\":1,\"编码\":\"010101001001\",\"类别\":\"钢筋\",\"名称\":\"热轧带肋钢筋\",\"规格型号\":\"HRB400 Φ12\",\"单位\":\"t\",\"数量\":10.5,\"不含税市场价\":4200,\"税率\":13}]",
      "region": "广东省-广州市",
      "timeRange": "2024-01 至 2024-12",
      "categories": "钢筋,水泥"
    },
    "response_mode": "blocking",
    "user": "test-user"
  }'
```

### 响应示例

```json
{
  "workflow_run_id": "run_xxxxxxxxxxxxx",
  "task_id": "task_xxxxxxxxxxxxx",
  "data": {
    "id": "xxxxxxxxxxxxx",
    "workflow_id": "xxxxxxxxxxxxx",
    "status": "succeeded",
    "outputs": {
      "results": [
        {
          "序号": 1,
          "编码": "010101001001",
          "推荐价格范围": "3800 - 4100",
          "价格偏差": "+5.26%"
        }
      ]
    },
    "created_at": 1699999999
  }
}
```

## 提示词(Prompt)建议

### 价格分析提示词

```
你是一个专业的建材价格审计专家。请分析以下材料的价格合理性：

材料信息：
- 编码：{编码}
- 名称：{名称}
- 规格型号：{规格型号}
- 上传价格：{不含税市场价} 元/{单位}
- 数量：{数量} {单位}

分析条件：
- 地区：{region}
- 时间范围：{timeRange}

请提供：
1. 该材料在指定地区和时间的合理价格区间
2. 上传价格与市场价格的偏差百分比
3. 价格合理性评估

输出格式：
推荐价格范围: X - Y
价格偏差: +/-Z%
```

### 批量分析提示词

```
你是一个专业的建材价格审计专家。请对以下材料清单进行批量价格审计：

材料清单：
{materials}

分析条件：
- 地区：{region}
- 时间范围：{timeRange}
- 关注类别：{categories}

对每个材料，请提供：
1. 基于地区和时间的推荐价格范围（不含税）
2. 价格偏差百分比

输出要求：
- 以JSON数组格式返回
- 每个元素包含：序号、编码、推荐价格范围、价格偏差
- 价格范围格式："最低价 - 最高价"
- 价格偏差格式："+X%"或"-X%"

示例输出：
[
  {
    "序号": 1,
    "编码": "010101001001",
    "推荐价格范围": "3800 - 4100",
    "价格偏差": "+5.26%"
  }
]
```

## 数据源集成建议

为了提高审计准确性，建议在Dify工作流中集成以下数据源：

### 1. 建材价格数据库

- **造价通**: 提供全国各地建材价格信息
- **建筑市场价格网**: 实时建材市场价格
- **各地工程造价信息网**: 官方价格发布平台

### 2. 知识库配置

在Dify中创建知识库，上传以下资料：

- 历史价格数据
- 地区价格差异表
- 材料价格趋势报告
- 供应商报价单

### 3. API集成

如有条件，可以在工作流中集成第三方价格API：

```python
# HTTP请求节点示例
import requests

def query_price(material_code, region):
    api_url = "https://api.price-service.com/query"
    response = requests.post(api_url, json={
        "code": material_code,
        "region": region
    })
    return response.json()
```

## 测试和调试

### 1. 单元测试

在Dify中创建测试用例：

```json
{
  "inputs": {
    "materials": "[{\"序号\":1,\"编码\":\"TEST001\",\"名称\":\"测试材料\",\"不含税市场价\":1000}]",
    "region": "广东省-广州市",
    "timeRange": "2024-01 至 2024-12",
    "categories": "测试类别"
  }
}
```

### 2. 性能测试

- 测试处理100条材料的响应时间
- 建议响应时间 < 30秒
- 如超时，考虑批量拆分或异步处理

### 3. 错误处理

确保工作流能处理以下异常：

- 材料信息不完整
- 地区信息无法识别
- 价格数据查询失败
- API调用超时

## 优化建议

### 1. 缓存策略

- 缓存常用材料的价格数据
- 设置合理的缓存过期时间（如1天）

### 2. 批量处理

- 对大量材料进行分批处理
- 每批建议不超过50条

### 3. 异步模式

如果审计耗时较长，可以使用异步模式：

```javascript
// 使用 streaming 模式
{
  "response_mode": "streaming",
  // ...
}
```

## 常见问题

### Q: Dify返回超时怎么办？

A: 
1. 减少单次处理的材料数量
2. 使用异步模式
3. 优化工作流节点，减少LLM调用次数

### Q: 如何提高价格分析准确性？

A:
1. 丰富知识库内容
2. 使用更强大的LLM模型
3. 集成实时价格数据API
4. 定期更新价格参考数据

### Q: 如何监控API调用状态？

A:
1. 在Dify控制台查看运行日志
2. 使用工作流的监控功能
3. 在应用层记录调用日志

## 联系支持

如需Dify相关技术支持：

- Dify官方文档: https://docs.dify.ai
- Dify社区: https://github.com/langgenius/dify
- 技术支持邮箱: support@dify.ai

