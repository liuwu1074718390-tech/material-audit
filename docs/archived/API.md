# API文档

## 后端API接口

### 1. 发起材价审计

**接口地址**: `POST /api/dify/audit`

**请求参数**:
```json
{
  "materials": [
    {
      "序号": 1,
      "编码": "010101001001",
      "类别": "钢筋",
      "名称": "热轧带肋钢筋",
      "规格型号": "HRB400 Φ12",
      "单位": "t",
      "数量": 10.5,
      "不含税市场价": 4200,
      "税率": 13,
      "不含税市场价合计": 44100
    }
  ],
  "region": "广东省-广州市",
  "timeRange": ["2024-01", "2024-12"],
  "categories": ["钢筋", "水泥"]
}
```

**响应数据**:
```json
[
  {
    "序号": 1,
    "编码": "010101001001",
    "类别": "钢筋",
    "名称": "热轧带肋钢筋",
    "规格型号": "HRB400 Φ12",
    "单位": "t",
    "数量": 10.5,
    "不含税市场价": 4200,
    "税率": 13,
    "不含税市场价合计": 44100,
    "推荐价格范围": "3800 - 4100",
    "价格偏差": "+5.26%",
    "价格偏差值": 5.26
  }
]
```

### 2. 查询审计记录

**接口地址**: `GET /api/audit-records`

**查询参数**:
- `limit`: 每页数量（默认100）
- `offset`: 偏移量（默认0）

**响应数据**:
```json
[
  {
    "序号": 1,
    "编码": "010101001001",
    "类别": "钢筋",
    "名称": "热轧带肋钢筋",
    "规格型号": "HRB400 Φ12",
    "单位": "t",
    "数量": 10.5,
    "不含税市场价": 4200,
    "税率": 13,
    "不含税市场价合计": 44100,
    "推荐价格范围": "3800 - 4100",
    "价格偏差": "+5.26%",
    "价格偏差值": 5.26
  }
]
```

## Dify工作流集成说明

### 环境变量配置

在 `.env` 文件中配置以下变量：

```env
DIFY_API_KEY=your_dify_api_key_here
DIFY_API_URL=https://api.dify.ai/v1/workflows/run
```

### Dify工作流输入

Dify工作流应该接收以下输入参数：

- `materials`: JSON字符串，包含所有材料数据
- `region`: 地区信息（可选）
- `timeRange`: 时间范围（可选）
- `categories`: 选择的类别（可选）

### Dify工作流输出

Dify工作流应该返回以下格式的数据：

```json
{
  "data": {
    "outputs": {
      "results": [
        {
          "序号": 1,
          "编码": "010101001001",
          "推荐价格范围": "3800 - 4100",
          "价格偏差": "+5.26%"
        }
      ]
    }
  }
}
```

### 工作流建议

1. **价格分析**: 基于地区和时间范围，分析材料的市场价格
2. **价格对比**: 对比上传的价格与市场价格
3. **偏差计算**: 计算价格偏差百分比
4. **推荐范围**: 给出合理的价格范围建议

## 数据库集成

### 腾讯云数据库配置

项目预留了腾讯云数据库集成接口，位于 `server/utils/database.ts`

需要安装腾讯云SDK：
```bash
npm install tencentcloud-sdk-nodejs
```

配置环境变量：
```env
TENCENT_SECRET_ID=your_secret_id
TENCENT_SECRET_KEY=your_secret_key
```

### 数据表结构建议

**audit_records** 表：

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | VARCHAR(50) | 主键 |
| 序号 | INT | 序号 |
| 编码 | VARCHAR(50) | 材料编码 |
| 类别 | VARCHAR(50) | 材料类别 |
| 名称 | VARCHAR(200) | 材料名称 |
| 规格型号 | VARCHAR(200) | 规格型号 |
| 单位 | VARCHAR(20) | 单位 |
| 数量 | DECIMAL(10,2) | 数量 |
| 不含税市场价 | DECIMAL(10,2) | 不含税市场价 |
| 税率 | DECIMAL(5,2) | 税率 |
| 不含税市场价合计 | DECIMAL(15,2) | 合计 |
| 推荐价格范围 | VARCHAR(100) | 推荐价格范围 |
| 价格偏差 | VARCHAR(20) | 价格偏差 |
| 价格偏差值 | DECIMAL(10,2) | 价格偏差值 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

